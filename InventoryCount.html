<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>棚卸カウント入力</title>
  <?!= include('Common'); ?>
</head>
<body class="bg-gray-100">
  <header class="bg-white shadow-md">
    <div class="container mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <h1 class="text-xl font-bold text-gray-900">在庫管理システム</h1>
        <button onclick="goHome()"
                class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
          ホームに戻る
        </button>
      </div>
    </div>
  </header>

  <div class="container mx-auto px-4 py-8">
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900">棚卸カウント入力（一括登録）</h1>
    </div>

    <!-- 絞り込み条件 -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">絞り込み条件</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- 棚卸イベント選択 -->
        <div>
          <label for="inventory-event" class="block text-sm font-medium text-gray-700 mb-2">
            棚卸イベント <span class="text-red-500">*</span>
          </label>
          <select id="inventory-event" required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">選択してください</option>
          </select>
        </div>

        <!-- 保管場所選択 -->
        <div>
          <label for="location" class="block text-sm font-medium text-gray-700 mb-2">
            保管場所 <span class="text-red-500">*</span>
          </label>
          <select id="location" required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">選択してください</option>
          </select>
        </div>

        <!-- カテゴリ1 -->
        <div>
          <label for="category1" class="block text-sm font-medium text-gray-700 mb-2">
            カテゴリ1
          </label>
          <select id="category1"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">すべて</option>
          </select>
        </div>

        <!-- カテゴリ2 -->
        <div>
          <label for="category2" class="block text-sm font-medium text-gray-700 mb-2">
            カテゴリ2
          </label>
          <select id="category2"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">すべて</option>
          </select>
        </div>
      </div>

      <div class="mt-4">
        <button onclick="loadProducts()"
                class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
          製品一覧を表示
        </button>
      </div>
    </div>

    <!-- メッセージ表示エリア -->
    <div id="error-message" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
      <p class="text-sm text-red-700"></p>
    </div>

    <div id="success-message" class="hidden bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
      <p class="text-sm text-green-700"></p>
    </div>

    <!-- 製品一覧＆カウント入力エリア -->
    <div id="products-area" class="hidden bg-white rounded-lg shadow-md p-6 mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-gray-900">製品一覧</h2>
        <div class="flex space-x-2">
          <button onclick="clearAllCounts()"
                  class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
            クリア
          </button>
          <button onclick="batchRegister()"
                  class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 font-semibold">
            一括登録
          </button>
        </div>
      </div>

      <div class="mb-4 text-sm text-gray-600">
        <p>※ カウント数を入力した製品のみ登録されます</p>
        <p>※ 複数箇所の在庫を計算する場合は「+」ボタンで入力欄を追加できます（マイナス値も入力可）</p>
        <p class="text-blue-600 font-medium">※ 「48×18」のように入り数×梱包数の形式で入力すると自動計算されます</p>
        <p class="text-red-600">※ 合計がマイナスになる場合は登録できません</p>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th style="width: 35%;">製品名</th>
              <th style="width: 15%;">カテゴリ1</th>
              <th style="width: 15%;">カテゴリ2</th>
              <th style="width: 35%;">カウント入力</th>
            </tr>
          </thead>
          <tbody id="products-tbody">
          </tbody>
        </table>
      </div>

      <div class="mt-4">
        <button onclick="batchRegister()"
                class="w-full bg-green-600 text-white py-3 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 font-semibold">
          一括登録
        </button>
      </div>
    </div>

    <!-- 入力履歴表示エリア -->
    <div id="history-area" class="bg-white rounded-lg shadow-md p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-gray-900">自分の入力履歴</h2>
        <button onclick="showMyCounts()"
                class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
          履歴を表示
        </button>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>製品名</th>
              <th>保管場所</th>
              <th>カウント数</th>
              <th>入力日時</th>
            </tr>
          </thead>
          <tbody id="history-tbody">
            <tr><td colspan="4" class="text-center text-gray-500">「履歴を表示」ボタンをクリックしてください</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let currentProducts = [];
    let allProducts = [];
    let countDataMap = {}; // 各製品のカウントデータを管理 { index: { productId, counts: [], total } }
    let countInputIdCounter = 0; // 入力欄のユニークID生成用

    window.addEventListener('load', function() {
      loadActiveInventoryEvents();
      loadLocations();
      loadCategory1List();

      document.getElementById('category1').addEventListener('change', handleCategory1Change);
      document.getElementById('category2').addEventListener('change', handleCategory2Change);
    });

    function loadActiveInventoryEvents() {
      google.script.run
        .withSuccessHandler(function(data) {
          const select = document.getElementById('inventory-event');
          data.forEach(event => {
            const option = document.createElement('option');
            option.value = event['棚卸ID'];
            option.textContent = `${event['イベント名']} (${event['棚卸実施日']}) - ${event['ステータス']}`;
            select.appendChild(option);
          });
        })
        .withFailureHandler(showError)
        .getActiveInventoryEvents();
    }

    function loadLocations() {
      google.script.run
        .withSuccessHandler(function(data) {
          const select = document.getElementById('location');
          data.forEach(loc => {
            const option = document.createElement('option');
            option.value = loc['保管場所ID'];
            option.textContent = loc['場所名'];
            select.appendChild(option);
          });
        })
        .withFailureHandler(showError)
        .getStorageLocations();
    }

    function loadCategory1List() {
      google.script.run
        .withSuccessHandler(function(data) {
          const select = document.getElementById('category1');
          data.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            select.appendChild(option);
          });
        })
        .withFailureHandler(showError)
        .getCategory1List();
    }

    function handleCategory1Change() {
      const category1 = document.getElementById('category1').value;
      const category2Select = document.getElementById('category2');

      category2Select.innerHTML = '<option value="">すべて</option>';

      if (category1) {
        google.script.run
          .withSuccessHandler(function(data) {
            data.forEach(cat => {
              const option = document.createElement('option');
              option.value = cat;
              option.textContent = cat;
              category2Select.appendChild(option);
            });
          })
          .withFailureHandler(showError)
          .getCategory2List(category1);
      }
    }

    function handleCategory2Change() {
      // カテゴリ2変更時は自動的には読み込まない
      // ユーザーが「製品一覧を表示」ボタンを押すまで待つ
    }

    function loadProducts() {
      const inventoryId = document.getElementById('inventory-event').value;
      const locationId = document.getElementById('location').value;

      if (!inventoryId) {
        showError('棚卸イベントを選択してください');
        return;
      }
      if (!locationId) {
        showError('保管場所を選択してください');
        return;
      }

      hideMessages();

      const category1 = document.getElementById('category1').value;
      const category2 = document.getElementById('category2').value;

      showLoading();
      google.script.run
        .withSuccessHandler(function(data) {
          hideLoading();
          allProducts = data;
          currentProducts = data;
          displayProducts(data);
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showError('製品の取得に失敗しました: ' + error.message);
        })
        .getProductsByCategory(category1, category2);
    }

    function displayProducts(products) {
      const tbody = document.getElementById('products-tbody');
      tbody.innerHTML = '';
      countDataMap = {}; // データマップをリセット

      if (products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500">製品が見つかりません</td></tr>';
      } else {
        products.forEach((product, index) => {
          // カウントデータを初期化
          countDataMap[index] = {
            productId: product['製品ID'],
            counts: [],
            total: 0
          };

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${product['製品名']}</td>
            <td>${product['カテゴリ1']}</td>
            <td>${product['カテゴリ2']}</td>
            <td>
              <div class="count-container" id="count-container-${index}">
                <!-- 入力欄グループ -->
                <div class="space-y-2 mb-2" id="inputs-${index}">
                  <div class="flex items-center gap-1" id="input-row-${index}-0">
                    <div class="flex-1">
                      <div class="flex">
                        <input type="text"
                               inputmode="numeric"
                               id="count-input-${index}-0"
                               class="count-input flex-1 px-2 py-1 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="例: 48×18"
                               data-index="${index}"
                               data-input-id="0"
                               oninput="updateTotal(${index})">
                        <button type="button"
                                onclick="insertMultiply(${index}, 0)"
                                class="px-2 py-1 bg-gray-200 hover:bg-gray-300 border border-l-0 border-gray-300 rounded-r-md text-gray-700 font-bold"
                                title="×を挿入">×</button>
                      </div>
                      <span class="calc-result text-xs text-gray-500" id="calc-result-${index}-0"></span>
                    </div>
                    <button type="button"
                            onclick="addCountInput(${index})"
                            class="text-green-600 hover:text-green-700 text-xl font-bold px-2 py-1 rounded hover:bg-green-50"
                            title="入力欄を追加">
                      +
                    </button>
                  </div>
                </div>
                <!-- 合計表示 -->
                <div class="pt-2 border-t border-gray-300">
                  <span id="total-display-${index}" class="font-semibold text-blue-600">
                    合計: <span id="total-${index}">0</span>
                  </span>
                </div>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      document.getElementById('products-area').classList.remove('hidden');
    }

    function addCountInput(index) {
      countInputIdCounter++;
      const inputId = countInputIdCounter;
      const inputsContainer = document.getElementById(`inputs-${index}`);

      const newRow = document.createElement('div');
      newRow.className = 'flex items-center gap-1';
      newRow.id = `input-row-${index}-${inputId}`;
      newRow.innerHTML = `
        <div class="flex-1">
          <div class="flex">
            <input type="text"
                   inputmode="numeric"
                   id="count-input-${index}-${inputId}"
                   class="count-input flex-1 px-2 py-1 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                   placeholder="例: 48×18"
                   data-index="${index}"
                   data-input-id="${inputId}"
                   oninput="updateTotal(${index})">
            <button type="button"
                    onclick="insertMultiply(${index}, ${inputId})"
                    class="px-2 py-1 bg-gray-200 hover:bg-gray-300 border border-l-0 border-gray-300 rounded-r-md text-gray-700 font-bold"
                    title="×を挿入">×</button>
          </div>
          <span class="calc-result text-xs text-gray-500" id="calc-result-${index}-${inputId}"></span>
        </div>
        <button type="button"
                onclick="removeCountInput(${index}, ${inputId})"
                class="text-red-600 hover:text-red-700 text-xl font-bold px-2 py-1 rounded hover:bg-red-50"
                title="この入力欄を削除">
          -
        </button>
      `;

      inputsContainer.appendChild(newRow);
    }

    function removeCountInput(index, inputId) {
      const row = document.getElementById(`input-row-${index}-${inputId}`);
      if (row) {
        row.remove();
        updateTotal(index);
      }
    }

    /**
     * 入力欄に「×」を挿入する（スマートフォン対応）
     */
    function insertMultiply(index, inputId) {
      const input = document.getElementById(`count-input-${index}-${inputId}`);
      if (input) {
        const cursorPos = input.selectionStart;
        const currentValue = input.value;
        const newValue = currentValue.slice(0, cursorPos) + '×' + currentValue.slice(cursorPos);
        input.value = newValue;
        // カーソルを×の後ろに移動
        input.setSelectionRange(cursorPos + 1, cursorPos + 1);
        input.focus();
        updateTotal(index);
      }
    }

    /**
     * 入力値をパースして数値を返す
     * 対応形式: "48", "-5", "48×18", "48*18", "48x18", "48X18"
     * @param {string} value - 入力値
     * @returns {object} { value: 数値, formula: 数式文字列 or null, error: エラー文字列 or null }
     */
    function parseCountInput(value) {
      if (!value || value.trim() === '') {
        return { value: null, formula: null, error: null };
      }

      const trimmed = value.trim();

      // 掛け算パターンをチェック（×, *, x, X に対応）
      const multiplyMatch = trimmed.match(/^(-?\d+)\s*[×\*xX]\s*(-?\d+)$/);
      if (multiplyMatch) {
        const num1 = parseInt(multiplyMatch[1]);
        const num2 = parseInt(multiplyMatch[2]);
        const result = num1 * num2;
        return {
          value: result,
          formula: `${num1}×${num2}`,
          error: null
        };
      }

      // 単純な数値パターン
      const numberMatch = trimmed.match(/^-?\d+$/);
      if (numberMatch) {
        return {
          value: parseInt(trimmed),
          formula: null,
          error: null
        };
      }

      // どのパターンにも一致しない場合はエラー
      return {
        value: null,
        formula: null,
        error: '無効な入力'
      };
    }

    function updateTotal(index) {
      const container = document.getElementById(`count-container-${index}`);
      if (!container) return;

      // すべての入力欄から値を取得
      const inputs = container.querySelectorAll('.count-input');
      let total = 0;
      let hasInput = false;
      let hasError = false;

      inputs.forEach(input => {
        const inputId = input.dataset.inputId;
        const resultSpan = document.getElementById(`calc-result-${index}-${inputId}`);
        const parsed = parseCountInput(input.value);

        if (parsed.error) {
          // エラーの場合
          hasError = true;
          if (resultSpan) {
            resultSpan.textContent = parsed.error;
            resultSpan.className = 'calc-result text-xs text-red-500';
          }
        } else if (parsed.value !== null) {
          // 有効な値がある場合
          total += parsed.value;
          hasInput = true;

          if (resultSpan) {
            if (parsed.formula) {
              // 数式の場合は計算結果を表示
              resultSpan.textContent = `= ${formatNumber(parsed.value)}`;
              resultSpan.className = 'calc-result text-xs text-green-600 font-medium';
            } else {
              // 単純な数値の場合は何も表示しない
              resultSpan.textContent = '';
              resultSpan.className = 'calc-result text-xs text-gray-500';
            }
          }
        } else {
          // 空の場合
          if (resultSpan) {
            resultSpan.textContent = '';
            resultSpan.className = 'calc-result text-xs text-gray-500';
          }
        }
      });

      // 合計を表示
      const totalDisplay = document.getElementById(`total-${index}`);
      const totalContainer = document.getElementById(`total-display-${index}`);
      if (totalDisplay) {
        totalDisplay.textContent = formatNumber(total);
      }

      // 合計がマイナスの場合は赤色で警告表示
      if (totalContainer) {
        if (hasError) {
          totalContainer.className = 'font-semibold text-red-600';
          totalDisplay.textContent = formatNumber(total) + ' (入力エラーあり)';
        } else if (total < 0) {
          totalContainer.className = 'font-semibold text-red-600';
          totalDisplay.textContent = formatNumber(total) + ' (マイナスのため登録不可)';
        } else if (hasInput && total === 0) {
          totalContainer.className = 'font-semibold text-orange-600';
        } else {
          totalContainer.className = 'font-semibold text-blue-600';
        }
      }

      // データマップを更新
      if (countDataMap[index]) {
        countDataMap[index].total = total;
        countDataMap[index].hasInput = hasInput;
        countDataMap[index].hasError = hasError;
      }
    }

    function clearAllCounts() {
      currentProducts.forEach((product, index) => {
        const container = document.getElementById(`count-container-${index}`);
        if (container) {
          // すべての入力欄をクリア
          const inputs = container.querySelectorAll('.count-input');
          inputs.forEach(input => {
            input.value = '';
          });
          // 合計をリセット
          updateTotal(index);
        }
      });
    }

    function batchRegister() {
      const inventoryId = document.getElementById('inventory-event').value;
      const locationId = document.getElementById('location').value;

      if (!inventoryId || !locationId) {
        showError('棚卸イベントと保管場所を選択してください');
        return;
      }

      hideMessages();

      // 入力された合計値を収集
      const dataList = [];
      const negativeProducts = [];
      const errorProducts = [];

      currentProducts.forEach((product, index) => {
        // 各製品の合計値を取得
        if (countDataMap[index] && countDataMap[index].hasInput) {
          // エラーがある製品をチェック
          if (countDataMap[index].hasError) {
            errorProducts.push(product['製品名']);
            return;
          }

          const total = countDataMap[index].total;

          // 合計がマイナスの製品をチェック
          if (total < 0) {
            negativeProducts.push(product['製品名']);
          } else if (total >= 0) {
            // 0以上の場合のみ登録対象（0も登録可能に変更）
            dataList.push({
              inventoryId: inventoryId,
              locationId: locationId,
              productId: product['製品ID'],
              count: total
            });
          }
        }
      });

      // 入力エラーがある場合
      if (errorProducts.length > 0) {
        showError(`以下の製品に入力エラーがあります：\n${errorProducts.join('、')}\n\n正しい形式で入力してください（例: 48 または 48×18）`);
        return;
      }

      // マイナスの製品がある場合はエラー
      if (negativeProducts.length > 0) {
        showError(`以下の製品の合計がマイナスになっています。マイナスでは登録できません：\n${negativeProducts.join('、')}`);
        return;
      }

      if (dataList.length === 0) {
        showError('カウント数が入力されていません');
        return;
      }

      if (!confirmAction(`${dataList.length}件の製品カウントを登録しますか？`)) {
        return;
      }

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            showSuccess(result.message);
            clearAllCounts();
            // 履歴を自動的に表示
            setTimeout(() => showMyCounts(), 1000);
          } else {
            showError(result.error);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showError('エラーが発生しました: ' + error.message);
        })
        .registerInventoryCountBatch(dataList);
    }

    function showMyCounts() {
      const inventoryId = document.getElementById('inventory-event').value;
      if (!inventoryId) {
        showError('棚卸イベントを選択してください');
        return;
      }

      showLoading();
      google.script.run
        .withSuccessHandler(function(data) {
          hideLoading();
          displayHistory(data);
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showError('履歴の取得に失敗しました: ' + error.message);
        })
        .getMyInventoryCounts(inventoryId);
    }

    function displayHistory(data) {
      const tbody = document.getElementById('history-tbody');
      tbody.innerHTML = '';

      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500">データがありません</td></tr>';
      } else {
        data.forEach(item => {
          const product = allProducts.find(p => p['製品ID'] === item['製品ID']);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${product ? product['製品名'] : ''}</td>
            <td>${item['保管場所ID']}</td>
            <td>${formatNumber(item['カウント数'])}</td>
            <td>${formatDateTime(item['入力日時'])}</td>
          `;
          tbody.appendChild(tr);
        });
      }
    }
  </script>
</body>
</html>
