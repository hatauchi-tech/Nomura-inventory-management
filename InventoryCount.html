<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>棚卸カウント入力</title>
  <?!= include('Common'); ?>
</head>
<body class="bg-gray-100">
  <header class="bg-white shadow-md">
    <div class="container mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <h1 class="text-xl font-bold text-gray-900">在庫管理システム</h1>
        <button onclick="goHome()" 
                class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
          ホームに戻る
        </button>
      </div>
    </div>
  </header>
  
  <div class="container mx-auto px-4 py-8">
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900">棚卸カウント入力</h1>
    </div>
    
    <div class="bg-white rounded-lg shadow-md p-6 max-w-2xl mx-auto">
      <form id="inventory-count-form" class="space-y-6">
        <!-- 棚卸イベント選択 -->
        <div>
          <label for="inventory-event" class="block text-sm font-medium text-gray-700 mb-2">
            棚卸イベント <span class="text-red-500">*</span>
          </label>
          <select id="inventory-event" name="inventoryId" required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">選択してください</option>
          </select>
        </div>
        
        <!-- 保管場所選択 -->
        <div>
          <label for="location" class="block text-sm font-medium text-gray-700 mb-2">
            保管場所 <span class="text-red-500">*</span>
          </label>
          <select id="location" name="locationId" required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">選択してください</option>
          </select>
        </div>
        
        <!-- カテゴリ1 -->
        <div>
          <label for="category1" class="block text-sm font-medium text-gray-700 mb-2">
            カテゴリ1（絞り込み）
          </label>
          <select id="category1" name="category1"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">すべて</option>
          </select>
        </div>
        
        <!-- カテゴリ2 -->
        <div>
          <label for="category2" class="block text-sm font-medium text-gray-700 mb-2">
            カテゴリ2（絞り込み）
          </label>
          <select id="category2" name="category2"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">すべて</option>
          </select>
        </div>
        
        <!-- 製品選択 -->
        <div>
          <label for="product" class="block text-sm font-medium text-gray-700 mb-2">
            製品 <span class="text-red-500">*</span>
          </label>
          <select id="product" name="productId" required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">選択してください</option>
          </select>
          <p class="mt-1 text-sm text-gray-500">カテゴリで絞り込んでから選択してください</p>
        </div>
        
        <!-- カウント数入力 -->
        <div>
          <label for="count" class="block text-sm font-medium text-gray-700 mb-2">
            カウント数 <span class="text-red-500">*</span>
          </label>
          <input type="number" id="count" name="count" required min="0"
                 class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                 placeholder="カウント数を入力">
        </div>
        
        <!-- メッセージ表示エリア -->
        <div id="error-message" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
          <p class="text-sm text-red-700"></p>
        </div>
        
        <div id="success-message" class="hidden bg-green-50 border border-green-200 rounded-lg p-4">
          <p class="text-sm text-green-700"></p>
        </div>
        
        <!-- ボタン -->
        <div class="flex space-x-4">
          <button type="submit"
                  class="flex-1 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">
            登録
          </button>
          <button type="button" onclick="showMyCounts()"
                  class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
            自分の入力履歴
          </button>
          <button type="button" onclick="goHome()"
                  class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500">
            戻る
          </button>
        </div>
      </form>
      
      <!-- 入力履歴表示エリア -->
      <div id="history-area" class="mt-8 hidden">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">自分の入力履歴</h2>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>製品ID</th>
                <th>製品名</th>
                <th>保管場所</th>
                <th>カウント数</th>
                <th>入力日時</th>
              </tr>
            </thead>
            <tbody id="history-tbody">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    let products = [];
    
    window.addEventListener('load', function() {
      loadActiveInventoryEvents();
      loadLocations();
      loadCategory1List();
      
      document.getElementById('category1').addEventListener('change', handleCategory1Change);
      document.getElementById('category2').addEventListener('change', handleCategory2Change);
      document.getElementById('inventory-count-form').addEventListener('submit', handleSubmit);
    });
    
    function loadActiveInventoryEvents() {
      google.script.run
        .withSuccessHandler(function(data) {
          const select = document.getElementById('inventory-event');
          data.forEach(event => {
            const option = document.createElement('option');
            option.value = event['棚卸ID'];
            option.textContent = `${event['棚卸ID']} (${formatDateTime(event['棚卸実施日'])}) - ${event['ステータス']}`;
            select.appendChild(option);
          });
        })
        .withFailureHandler(showError)
        .getActiveInventoryEvents();
    }
    
    function loadLocations() {
      google.script.run
        .withSuccessHandler(function(data) {
          const select = document.getElementById('location');
          data.forEach(loc => {
            const option = document.createElement('option');
            option.value = loc['保管場所ID'];
            option.textContent = loc['場所名'];
            select.appendChild(option);
          });
        })
        .withFailureHandler(showError)
        .getStorageLocations();
    }
    
    function loadCategory1List() {
      google.script.run
        .withSuccessHandler(function(data) {
          const select = document.getElementById('category1');
          data.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            select.appendChild(option);
          });
        })
        .withFailureHandler(showError)
        .getCategory1List();
    }
    
    function handleCategory1Change() {
      const category1 = document.getElementById('category1').value;
      const category2Select = document.getElementById('category2');
      
      category2Select.innerHTML = '<option value="">すべて</option>';
      
      if (category1) {
        google.script.run
          .withSuccessHandler(function(data) {
            data.forEach(cat => {
              const option = document.createElement('option');
              option.value = cat;
              option.textContent = cat;
              category2Select.appendChild(option);
            });
          })
          .withFailureHandler(showError)
          .getCategory2List(category1);
      }
      loadProducts();
    }
    
    function handleCategory2Change() {
      loadProducts();
    }
    
    function loadProducts() {
      const category1 = document.getElementById('category1').value;
      const category2 = document.getElementById('category2').value;
      
      google.script.run
        .withSuccessHandler(function(data) {
          products = data;
          const select = document.getElementById('product');
          select.innerHTML = '<option value="">選択してください</option>';
          
          data.forEach(prod => {
            const option = document.createElement('option');
            option.value = prod['製品ID'];
            option.textContent = `${prod['製品ID']} - ${prod['製品名']}`;
            select.appendChild(option);
          });
        })
        .withFailureHandler(showError)
        .getProductsByCategory(category1, category2);
    }
    
    function handleSubmit(e) {
      e.preventDefault();
      hideMessages();
      
      const formData = new FormData(e.target);
      const data = {
        inventoryId: formData.get('inventoryId'),
        locationId: formData.get('locationId'),
        productId: formData.get('productId'),
        count: formData.get('count')
      };
      
      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            showSuccess(result.message);
            document.getElementById('count').value = '';
          } else {
            showError(result.error);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showError('エラーが発生しました: ' + error.message);
        })
        .registerInventoryCount(data);
    }
    
    function showMyCounts() {
      const inventoryId = document.getElementById('inventory-event').value;
      if (!inventoryId) {
        showError('棚卸イベントを選択してください');
        return;
      }
      
      showLoading();
      google.script.run
        .withSuccessHandler(function(data) {
          hideLoading();
          displayHistory(data);
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showError('履歴の取得に失敗しました: ' + error.message);
        })
        .getMyInventoryCounts(inventoryId);
    }
    
    function displayHistory(data) {
      const tbody = document.getElementById('history-tbody');
      tbody.innerHTML = '';
      
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500">データがありません</td></tr>';
      } else {
        data.forEach(item => {
          const product = products.find(p => p['製品ID'] === item['製品ID']);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${item['製品ID']}</td>
            <td>${product ? product['製品名'] : ''}</td>
            <td>${item['保管場所ID']}</td>
            <td>${formatNumber(item['カウント数'])}</td>
            <td>${formatDateTime(item['入力日時'])}</td>
          `;
          tbody.appendChild(tr);
        });
      }
      
      document.getElementById('history-area').classList.remove('hidden');
    }
  </script>
</body>
</html>