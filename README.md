# 在庫管理システム

Google Apps Script (GAS) を使用した製品在庫管理Webアプリケーション

## 概要

このシステムは、製品の入出庫管理、棚卸業務、在庫照会をWebブラウザから行えるアプリケーションです。Googleスプレッドシートをデータベースとして使用し、ユーザー認証・権限管理を備えています。

### 主な特徴

- Googleアカウント認証による安全なアクセス
- ユーザー権限管理（管理者/現場担当）
- 入出庫登録と履歴管理（編集・削除・製品変更機能付き）
- 棚卸機能（複数製品の一括登録対応、複数担当者によるカウント・照合、計算式入力対応）
- 在庫検索・集計表示（カテゴリ絞り込み対応、適正在庫アラート表示）
- 適正在庫アラート（在庫が適正在庫数を下回った際、担当部署の管理者にメール自動送信）
- 過去データ調整（過去3ヶ月以内の履歴を遡って補正登録、現在在庫に影響なし）
- マスタデータ管理（ID自動採番）
- レスポンシブデザイン（スマホ対応）
- 全関数の実行ログ出力機能

## 機能一覧

### 全ユーザー共通機能

| 機能 | 説明 |
|------|------|
| **入出庫登録** | 製品の入庫・出庫を記録。出庫時は現場名・客先を入力可能。入庫は管理者のみ |
| **入出庫履歴確認** | 自分が登録した入出庫履歴の確認・編集・削除・製品変更。在庫も自動連動 |
| **棚卸カウント入力** | 実在庫をカウントして入力。複数製品の一括登録、計算式入力（例: 48×18）、マイナス入力に対応 |
| **在庫一覧・検索** | カテゴリ・製品名で在庫を検索。製品別/保管場所別の集計表示 |

### 管理者専用機能

| 機能 | 説明 |
|------|------|
| **入出庫履歴確認（全ユーザー）** | 全ユーザーの入出庫履歴を確認・編集・削除・製品変更可能 |
| **棚卸照合・確定** | 棚卸イベント作成、複数担当者のカウント照合、在庫確定・調整 |
| **マスタ管理** | 製品・ユーザー・保管場所の登録/編集/削除（ID自動採番、適正在庫数・担当部署設定） |
| **過去データ調整** | 過去3ヶ月以内の履歴を遡って補正登録（現在在庫には影響なし） |

## システム構成

```
在庫管理システム
│
├── Google Apps Script (Webアプリ)
│   ├── Code.gs              # エントリーポイント（ルーティング、画面遷移）
│   ├── ServerSide.gs        # ビジネスロジック（全サーバーサイド処理）
│   └── HTML Files           # 各画面
│       ├── Index.html           # ログイン画面
│       ├── HomeAdmin.html       # 管理者ホーム
│       ├── HomeUser.html        # 一般ユーザーホーム
│       ├── StockMovement.html   # 入出庫登録
│       ├── StockMovementHistory.html # 入出庫履歴確認
│       ├── InventoryCount.html  # 棚卸カウント入力
│       ├── InventoryVerify.html # 棚卸照合・確定
│       ├── StockList.html       # 在庫一覧・検索
│       ├── MasterManagement.html # マスタ管理
│       ├── PastStockAdjustment.html # 過去データ調整
│       └── Common.html          # 共通CSS/JS
│
└── Googleスプレッドシート (データベース)
    ├── M_ユーザー          # ユーザーマスタ
    ├── M_製品              # 製品マスタ
    ├── M_保管場所          # 保管場所マスタ
    ├── T_在庫              # 在庫テーブル
    ├── T_入出庫履歴        # 入出庫履歴テーブル
    ├── T_棚卸履歴          # 棚卸イベントテーブル
    ├── T_棚卸明細          # 棚卸明細テーブル
    └── T_棚卸担当者別入力  # 棚卸カウント入力テーブル
```

## セットアップ手順

### 1. スプレッドシートの準備

新規Googleスプレッドシートを作成し、以下のシートを追加してください：

#### M_ユーザー
| ユーザーID | 部門 | ユーザー名 | メールアドレス | 権限 | 有効 |
|-----------|------|-----------|--------------|------|------|
| U001 | 管理部 | 山田太郎 | yamada@example.com | 管理者 | TRUE |

#### M_製品
| 製品ID | 製品名 | カテゴリ1 | カテゴリ2 | 有効 | 単価 | 適正在庫数 | 担当部署 |
|--------|--------|-----------|-----------|------|------|----------|---------|
| 1 | 製品A | カテゴリ1 | サブカテゴリ1 | TRUE | 1000 | 100 | 管理部 |

#### M_保管場所
| 保管場所ID | 場所名 |
|-----------|--------|
| P001 | 倉庫A |

#### T_在庫
| 在庫ID | 製品ID | 保管場所ID | 現在在庫数 | 最終更新日時 |
|--------|--------|-----------|-----------|--------------|

#### T_入出庫履歴
| 履歴ID | 製品ID | 数量 | 入出庫タイプ | 現場名 | 客先 | 発生日時 | 操作ユーザーID | 保管場所ID |
|--------|--------|------|-------------|--------|------|----------|---------------|-----------|

#### T_棚卸履歴
| 棚卸ID | イベント名 | 棚卸実施日 | ステータス | 担当ユーザーID |
|--------|-----------|-----------|-----------|---------------|

#### T_棚卸明細
| 棚卸明細ID | 棚卸ID | 製品ID | 保管場所ID | 理論在庫数 | 確定実在庫数 | 差異 | 差異理由 |
|-----------|--------|--------|-----------|-----------|-------------|------|---------|

#### T_棚卸担当者別入力
| 入力ID | 棚卸ID | 担当ユーザーID | 製品ID | 保管場所ID | カウント数 | 入力日時 |
|--------|--------|---------------|--------|-----------|-----------|----------|

### 2. GASプロジェクトの作成

1. スプレッドシートから「拡張機能」→「Apps Script」を開く
2. 以下のファイルを作成:
   - `Code.gs`
   - `ServerSide.gs`
   - HTML各ファイル（.htmlとして）

### 3. スクリプトプロパティの設定（オプション）

別のスプレッドシートを使用する場合:
```
スクリプトプロパティ:
SPREADSHEET_ID = [スプレッドシートID]
```

### 4. Webアプリとしてデプロイ

1. 「デプロイ」→「新しいデプロイ」
2. 種類: Webアプリ
3. 実行ユーザー: 「アクセスしているユーザー」
4. アクセス権限: 「全員」（または組織内）
5. デプロイ完了後、URLをコピー

### 5. 初期データ投入

M_ユーザーシートに管理者ユーザーを登録（自分のGoogleアカウントのメールアドレスを使用）

## 使い方

### ログイン

1. デプロイしたWebアプリのURLにアクセス
2. Googleアカウントで認証
3. M_ユーザーテーブルに登録されている場合、自動的にホーム画面へ

### 入出庫登録

1. ホーム画面から「入出庫登録」を選択
2. 入庫/出庫を選択（入庫は管理者のみ）
3. 保管場所、カテゴリ1、カテゴリ2、製品を選択
4. 数量を入力
5. 出庫の場合は現場名と客先も入力
6. 「登録」ボタンで完了

### 入出庫履歴確認

1. ホーム画面から「入出庫履歴確認」を選択
2. 絞り込み条件（タイプ、保管場所、カテゴリ、日付範囲、現場名、客先）を設定
3. 「履歴を表示」ボタンで一覧表示
4. 「編集」ボタンで数量・現場名・客先を変更可能（在庫も自動連動）
5. 「削除」ボタンで履歴を削除（在庫も元に戻る）
6. 「製品変更」ボタンで製品を変更可能（在庫も自動連動：旧製品の在庫を戻し、新製品に反映）

### 棚卸業務

#### 棚卸イベント作成（管理者）
1. 「棚卸照合・確定」画面へ
2. イベント名を入力して「イベント作成」
3. 自動的に現在の在庫状況がスナップショットとして保存される

#### カウント入力（全ユーザー）
1. 「棚卸カウント入力」画面へ
2. 棚卸イベントを選択
3. 保管場所を選択
4. 複数の製品とカウント数を入力
   - 単純な数値: `48`
   - 計算式（入り数×梱包数）: `48×18`、`48*18`、`48x18`（自動計算で864に）
   - マイナス入力: `-5`（ただし合計がマイナスになる場合は登録不可）
5. 「一括登録」で複数製品を同時に登録可能
6. 「自分の入力履歴」で確認可能

#### 照合・確定（管理者）
1. 「棚卸照合・確定」画面へ
2. 棚卸イベントを選択
3. 「照合実行」で複数担当者のカウント不一致をチェック
4. 「明細表示」で確定実在庫数と差異理由を入力
5. 「棚卸を確定する」で在庫を更新

### 在庫検索

1. 「在庫一覧・検索」画面へ
2. カテゴリや製品名で検索
3. 「全在庫表示」「製品別集計」「保管場所別集計」で表示切替

## データベース構造詳細

### リレーションシップ

```
M_製品 ──< T_在庫 >── M_保管場所
   │
   └──< T_入出庫履歴 >── M_ユーザー
   │
   └──< T_棚卸明細 >── T_棚卸履歴 ── M_ユーザー
                           │
                           └──< T_棚卸担当者別入力 >── M_ユーザー
```

### ID採番ルール

| テーブル | ID形式 | 例 |
|---------|--------|-----|
| M_製品 | 数値連番 | 1, 2, 3... |
| M_ユーザー | U + 3桁連番 | U001, U002... |
| M_保管場所 | P + 3桁連番 | P001, P002... |
| T_在庫 | S + タイムスタンプ + ランダム3桁 | S17001234567890123 |
| T_入出庫履歴 | H + タイムスタンプ + ランダム3桁 | H17001234567890456 |
| T_棚卸履歴 | I + タイムスタンプ + ランダム3桁 | I17001234567890789 |
| T_棚卸明細 | ID + タイムスタンプ + ランダム3桁 | ID17001234567890012 |
| T_棚卸担当者別入力 | IC + タイムスタンプ + ランダム3桁 | IC17001234567890345 |

## 開発情報

### 技術スタック

- **バックエンド**: Google Apps Script (V8 Runtime)
- **データベース**: Google Spreadsheet
- **フロントエンド**: HTML5, JavaScript (ES6+)
- **CSSフレームワーク**: Tailwind CSS (CDN)
- **認証**: Google Account Authentication

### ファイル構成

| ファイル | 説明 |
|---------|------|
| `Code.gs` | エントリーポイント。`doGet()`によるルーティング、`include()`によるHTML埋め込み |
| `ServerSide.gs` | サーバーサイドロジック。認証、入出庫、棚卸、在庫照会、マスタ管理の全機能 |
| `Common.html` | 共通CSS/JS。Tailwind CSS、ローディング表示、メッセージ表示、バリデーション関数 |

### 主要関数一覧（ServerSide.gs）

#### ロギング
| 関数 | 説明 |
|------|------|
| `loggable(fnName, args, fn)` | 関数実行の開始・終了・エラーをログ出力するラッパー |

#### ユーティリティ
| 関数 | 説明 |
|------|------|
| `getSpreadsheet()` | スプレッドシートを取得（プロパティまたはアクティブ） |
| `generateUniqueId(prefix)` | 一意のIDを生成 |
| `getSheetData(sheet)` | シートデータをオブジェクト配列で取得 |
| `appendRowToSheet(sheet, rowData)` | シートに行を追加 |
| `updateSheetRow(sheet, rowIndex, rowData)` | シートの行を更新 |
| `findRowByColumn(sheet, columnName, value)` | 列の値で行を検索（単一） |
| `findAllRowsByColumn(sheet, columnName, value)` | 列の値で行を検索（複数） |
| `validateRequiredFields(data, requiredFields)` | 必須項目バリデーション |
| `validateNumber(value, min, max)` | 数値バリデーション |

#### 認証・認可
| 関数 | 説明 |
|------|------|
| `getCurrentUser()` | 現在のユーザー情報を取得 |
| `checkUserPermission(requiredRole)` | 権限チェック |
| `requireAdminPermission()` | 管理者権限必須チェック（エラースロー） |

#### 入出庫管理
| 関数 | 説明 |
|------|------|
| `getStorageLocations()` | 保管場所一覧を取得 |
| `getCategory1List()` | カテゴリ1一覧を取得 |
| `getCategory2List(category1)` | カテゴリ2一覧を取得 |
| `getProductsByCategory(category1, category2)` | カテゴリで製品を絞り込み |
| `getCurrentStock(productId, locationId)` | 現在在庫数を取得 |
| `registerStockMovement(data)` | 入出庫登録（入庫は管理者のみ、出庫時に適正在庫チェック） |
| `registerPastStockMovement(data)` | 過去データ調整登録（管理者のみ、在庫に影響なし） |
| `sendLowStockAlert(productId, locationId, currentStock, optimalStock)` | 適正在庫アラートメール送信（内部関数） |
| `updateStock(productId, locationId, quantity, type)` | 在庫を更新（内部関数） |

#### 入出庫履歴管理
| 関数 | 説明 |
|------|------|
| `getMyStockMovements(filters)` | 入出庫履歴を取得（管理者は全件、一般は自分のみ） |
| `updateStockMovement(historyId, newData)` | 入出庫履歴を更新（在庫連動） |
| `deleteStockMovement(historyId)` | 入出庫履歴を削除（在庫連動） |
| `changeProductInHistory(historyId, newProductId)` | 入出庫履歴の製品を変更（旧製品の在庫を戻し、新製品に反映） |

#### 棚卸管理
| 関数 | 説明 |
|------|------|
| `createInventoryEvent(eventName)` | 棚卸イベント作成 |
| `createInventorySnapshot(inventoryId)` | 棚卸スナップショット作成（内部関数） |
| `getActiveInventoryEvents()` | アクティブな棚卸イベント一覧を取得 |
| `registerInventoryCount(data)` | カウント登録（単一） |
| `registerInventoryCountBatch(dataList)` | カウント登録（一括） |
| `getInventoryCountsByEvent(inventoryId)` | イベントのカウント一覧を取得（管理者） |
| `getMyInventoryCounts(inventoryId)` | 自分のカウント一覧を取得 |
| `verifyInventoryCounts(inventoryId)` | カウント照合 |
| `getInventoryDetails(inventoryId)` | 棚卸明細を取得 |
| `finalizeInventory(inventoryId, details)` | 棚卸確定 |

#### 在庫照会
| 関数 | 説明 |
|------|------|
| `getAllStocks()` | 全在庫を取得（適正在庫数・担当部署含む） |
| `searchStocks(query)` | 在庫を検索（製品名、カテゴリ1、カテゴリ2） |
| `getStocksByProduct()` | 製品別集計 |
| `getStocksByLocation()` | 保管場所別集計 |

#### マスタ管理（製品）
| 関数 | 説明 |
|------|------|
| `getAllProducts()` | 全製品を取得 |
| `createProduct(data)` | 製品を作成（ID自動採番、適正在庫数・担当部署設定可） |
| `updateProduct(productId, data)` | 製品を更新（適正在庫数・担当部署更新可） |
| `deleteProduct(productId)` | 製品を論理削除 |

#### マスタ管理（ユーザー）
| 関数 | 説明 |
|------|------|
| `getAllUsers()` | 全ユーザーを取得 |
| `createUser(data)` | ユーザーを作成（ID自動採番） |
| `updateUser(userId, data)` | ユーザーを更新 |
| `deleteUser(userId)` | ユーザーを論理削除 |

#### マスタ管理（保管場所）
| 関数 | 説明 |
|------|------|
| `getAllLocations()` | 全保管場所を取得 |
| `createLocation(data)` | 保管場所を作成（ID自動採番） |
| `updateLocation(locationId, data)` | 保管場所を更新 |
| `deleteLocation(locationId)` | 保管場所を削除（使用中は削除不可） |

### ロギング機能

全ての`google.script.run`で呼び出される関数は`loggable()`ラッパーで囲まれており、以下の情報をログ出力:
- 関数開始時刻と引数（500文字で切り詰め）
- 関数終了時刻と戻り値（500文字で切り詰め）
- エラー発生時のエラーメッセージとスタックトレース

ログは「Apps Script」→「実行数」から確認可能。

### エラーハンドリング

- シート取得時のnullチェック
- 必須項目バリデーション
- 数値範囲チェック
- 在庫不足チェック（出庫時）
- 重複チェック（メールアドレス等）
- Try-Catch による例外処理
- 詳細なエラー画面表示

### 権限管理

| 操作 | 管理者 | 現場担当 |
|------|--------|---------|
| 入庫登録 | OK | NG |
| 出庫登録 | OK | OK |
| 入出庫履歴確認（自分） | OK | OK |
| 入出庫履歴確認（全員） | OK | NG |
| 棚卸カウント入力 | OK | OK |
| 棚卸照合・確定 | OK | NG |
| マスタ管理 | OK | NG |
| 過去データ調整 | OK | NG |

## トラブルシューティング

### 「T_棚卸履歴シートが見つかりません」エラー

**原因**: 必要なシートが存在しない

**対処法**: スプレッドシートに以下のシートを作成
- T_棚卸履歴
- T_棚卸明細
- T_棚卸担当者別入力
- T_在庫
- T_入出庫履歴
- M_ユーザー
- M_製品
- M_保管場所

### ログイン画面から進めない

**原因**: M_ユーザーテーブルにメールアドレスが登録されていない

**対処法**:
1. スプレッドシートのM_ユーザーシートを開く
2. 自分のGoogleアカウントのメールアドレスを登録
3. 「有効」列をTRUEに設定

### ページ遷移ができない（空白画面）

**原因**: `getScriptUrl()`が正しく動作していない

**対処法**:
1. ブラウザのコンソール（F12）でエラーを確認
2. デプロイURLを再確認
3. 再デプロイを実施

### 在庫数が合わない

**原因**: 入出庫履歴の編集・削除、または棚卸確定による調整

**対処法**:
1. T_入出庫履歴シートで「棚卸調整」タイプのレコードを確認
2. 「入出庫履歴確認」画面で操作履歴を確認
3. 必要に応じて手動で調整

### 製品IDやユーザーIDが見つからない

**原因**: ID形式の不一致（文字列と数値の比較問題）

**対処法**:
- システムは内部でString型に変換して比較しています
- スプレッドシートでIDの表示形式を確認してください

## 画面フロー図

```
[ログイン画面]
      ↓
[ホーム画面] ─┬─→ [入出庫登録]
              ├─→ [入出庫履歴確認] ←── 編集・削除機能
              ├─→ [棚卸カウント入力] ←── 一括登録機能
              ├─→ [在庫一覧・検索]
              │
              └─→ [管理者専用]
                      ├─→ [棚卸照合・確定]
                      └─→ [マスタ管理]
```

## 今後の拡張案

- [ ] CSVエクスポート機能
- [x] 在庫アラート機能（適正在庫数の設定とメール通知）- 実装済み
- [ ] バーコードスキャン対応
- [ ] ダッシュボード機能（在庫推移グラフ）
- [ ] 承認フロー機能
- [ ] モバイルアプリ化
- [ ] 複数拠点間の在庫移動機能

## ライセンス

このプロジェクトは内部使用を想定しています。

## サポート

質問や不具合報告は、プロジェクト管理者までお問い合わせください。

---

**作成者**: PromptSmith
**最終更新**: 2025年11月
**バージョン**: 1.3.0
