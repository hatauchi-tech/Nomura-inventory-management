# 在庫管理システム

Google Apps Script (GAS) を使用した製品在庫管理Webアプリケーション

## 📋 概要

このシステムは、製品の入出庫管理、棚卸業務、在庫照会をWebブラウザから行えるアプリケーションです。Googleスプレッドシートをデータベースとして使用し、ユーザー認証・権限管理を備えています。

### 主な特徴

- 🔐 Googleアカウント認証
- 👥 ユーザー権限管理（管理者/現場担当）
- 📦 入出庫登録と履歴管理
- 📊 棚卸機能（複数担当者によるカウント・照合）
- 🔍 在庫検索・集計表示
- ⚙️ マスタデータ管理
- 📱 レスポンシブデザイン（スマホ対応）

## 🚀 機能一覧

### 全ユーザー共通機能

| 機能 | 説明 |
|------|------|
| **入出庫登録** | 製品の入庫・出庫を記録。出庫時は現場名・客先を入力可能 |
| **棚卸カウント入力** | 実在庫をカウントして入力。自分の入力履歴を確認可能 |
| **在庫一覧・検索** | カテゴリ・製品名で在庫を検索。製品別/保管場所別の集計表示 |

### 管理者専用機能

| 機能 | 説明 |
|------|------|
| **棚卸照合・確定** | 棚卸イベント作成、カウント照合、在庫確定・調整 |
| **マスタ管理** | 製品・ユーザー・保管場所の登録/編集/削除 |

## 🏗️ システム構成

```
在庫管理システム
│
├── Google Apps Script (Webアプリ)
│   ├── Code.gs (エントリーポイント)
│   ├── ServerSide.gs (ビジネスロジック)
│   └── HTML Files (各画面)
│       ├── Index.html (ログイン)
│       ├── HomeAdmin.html / HomeUser.html
│       ├── StockMovement.html (入出庫)
│       ├── InventoryCount.html (棚卸入力)
│       ├── InventoryVerify.html (棚卸確定)
│       ├── StockList.html (在庫一覧)
│       ├── MasterManagement.html (マスタ管理)
│       └── Common.html (共通CSS/JS)
│
└── Googleスプレッドシート (データベース)
    ├── M_ユーザー
    ├── M_製品
    ├── M_保管場所
    ├── T_在庫
    ├── T_入出庫履歴
    ├── T_棚卸履歴
    ├── T_棚卸明細
    └── T_棚卸担当者別入力
```

## 📝 セットアップ手順

### 1. スプレッドシートの準備

新規Googleスプレッドシートを作成し、以下のシートを追加してください：

#### M_ユーザー
| ユーザーID | 部門 | ユーザー名 | メールアドレス | 権限 | 有効 |
|-----------|------|-----------|--------------|------|------|
| U001 | 管理部 | 山田太郎 | yamada@example.com | 管理者 | TRUE |

#### M_製品
| 製品ID | 製品名 | カテゴリ1 | カテゴリ2 | 有効 | 単価 |
|--------|--------|-----------|-----------|------|------|
| P001 | 製品A | カテゴリ1 | サブカテゴリ1 | TRUE | 1000 |

#### M_保管場所
| 保管場所ID | 場所名 |
|-----------|--------|
| L001 | 倉庫A |

#### T_在庫
| 在庫ID | 製品ID | 保管場所ID | 現在在庫数 | 最終更新日時 |
|--------|--------|-----------|-----------|--------------|

#### T_入出庫履歴
| 履歴ID | 製品ID | 数量 | 入出庫タイプ | 現場名 | 客先 | 発生日時 | 操作ユーザーID | 保管場所ID |
|--------|--------|------|-------------|--------|------|----------|---------------|-----------|

#### T_棚卸履歴
| 棚卸ID | 棚卸実施日 | ステータス | 担当ユーザーID |
|--------|-----------|-----------|---------------|

#### T_棚卸明細
| 棚卸明細ID | 棚卸ID | 製品ID | 保管場所ID | 理論在庫数 | 確定実在庫数 | 差異 | 差異理由 |
|-----------|--------|--------|-----------|-----------|-------------|------|---------|

#### T_棚卸担当者別入力
| 入力ID | 棚卸ID | 担当ユーザーID | 製品ID | 保管場所ID | カウント数 | 入力日時 |
|--------|--------|---------------|--------|-----------|-----------|----------|

### 2. GASプロジェクトの作成

1. スプレッドシートから「拡張機能」→「Apps Script」を開く
2. 以下のファイルを作成:
   - `Code.gs`
   - `ServerSide.gs`
   - HTML各ファイル（.htmlとして）

### 3. スクリプトプロパティの設定（オプション）

別のスプレッドシートを使用する場合:
```
スクリプトプロパティ:
SPREADSHEET_ID = [スプレッドシートID]
```

### 4. Webアプリとしてデプロイ

1. 「デプロイ」→「新しいデプロイ」
2. 種類: Webアプリ
3. 実行ユーザー: 「アクセスしているユーザー」
4. アクセス権限: 「全員」（または組織内）
5. デプロイ完了後、URLをコピー

### 5. 初期データ投入

M_ユーザーシートに管理者ユーザーを登録（自分のGoogleアカウントのメールアドレスを使用）

## 💡 使い方

### ログイン

1. デプロイしたWebアプリのURLにアクセス
2. Googleアカウントで認証
3. M_ユーザーテーブルに登録されている場合、自動的にホーム画面へ

### 入出庫登録

1. ホーム画面から「入出庫登録」を選択
2. 入庫/出庫を選択
3. 保管場所、製品、数量を入力
4. 出庫の場合は現場名と客先も入力
5. 「登録」ボタンで完了

### 棚卸業務（管理者）

#### 棚卸イベント作成
1. 「棚卸照合・確定」画面へ
2. イベント名を入力して「イベント作成」
3. 自動的に現在の在庫状況がスナップショットとして保存される

#### カウント入力（全ユーザー）
1. 「棚卸カウント入力」画面へ
2. 棚卸イベントを選択
3. 保管場所、製品を選択してカウント数を入力
4. 「自分の入力履歴」で確認可能

#### 照合・確定（管理者）
1. 「棚卸照合・確定」画面へ
2. 棚卸イベントを選択
3. 「照合実行」で複数担当者のカウント不一致をチェック
4. 「明細表示」で確定実在庫数と差異理由を入力
5. 「棚卸を確定する」で在庫を更新

### 在庫検索

1. 「在庫一覧・検索」画面へ
2. カテゴリや製品名で検索
3. 「全在庫表示」「製品別集計」「保管場所別集計」で表示切替

## 🗄️ データベース構造詳細

### リレーションシップ

```
M_製品 ──< T_在庫 >── M_保管場所
   │
   └──< T_入出庫履歴 >── M_ユーザー
   │
   └──< T_棚卸明細 >── T_棚卸履歴 ── M_ユーザー
                           │
                           └──< T_棚卸担当者別入力 >── M_ユーザー
```

### ID採番ルール

- 製品ID: `P` + タイムスタンプ + ランダム3桁
- ユーザーID: 手動設定（例: U001）
- 在庫ID: `S` + タイムスタンプ + ランダム3桁
- 履歴ID: `H` + タイムスタンプ + ランダム3桁
- 棚卸ID: `I` + タイムスタンプ + ランダム3桁

## 🔧 開発情報

### 技術スタック

- **バックエンド**: Google Apps Script (V8 Runtime)
- **データベース**: Google Spreadsheet
- **フロントエンド**: HTML5, JavaScript (ES6+)
- **CSSフレームワーク**: Tailwind CSS (CDN)
- **認証**: Google Account Authentication

### 主要関数一覧

#### ServerSide.gs

**認証・認可**
- `getCurrentUser()` - 現在のユーザー情報を取得
- `checkUserPermission()` - 権限チェック
- `requireAdminPermission()` - 管理者権限必須チェック

**入出庫管理**
- `registerStockMovement(data)` - 入出庫登録
- `getCurrentStock(productId, locationId)` - 現在在庫数取得
- `updateStock(productId, locationId, quantity, type)` - 在庫更新

**棚卸管理**
- `createInventoryEvent(eventName)` - 棚卸イベント作成
- `registerInventoryCount(data)` - カウント登録
- `verifyInventoryCounts(inventoryId)` - カウント照合
- `finalizeInventory(inventoryId, details)` - 棚卸確定

**在庫照会**
- `getAllStocks()` - 全在庫取得
- `searchStocks(query)` - 在庫検索
- `getStocksByProduct()` - 製品別集計
- `getStocksByLocation()` - 保管場所別集計

**マスタ管理**
- `getAllProducts()` / `createProduct()` / `updateProduct()` / `deleteProduct()`
- `getAllUsers()` / `createUser()` / `updateUser()` / `deleteUser()`
- `getAllLocations()` / `createLocation()` / `updateLocation()` / `deleteLocation()`

### ロギング機能

全ての`google.script.run`で呼び出される関数は`loggable()`ラッパーで囲まれており、以下の情報をログ出力:
- 関数開始時刻と引数
- 関数終了時刻と戻り値
- エラー発生時のスタックトレース

ログは「Apps Script」→「実行数」から確認可能。

### エラーハンドリング

- シート取得時のnullチェック
- 必須項目バリデーション
- 数値範囲チェック
- 在庫不足チェック（出庫時）
- 重複IDチェック
- Try-Catch による例外処理

## 🐛 トラブルシューティング

### 「T_棚卸履歴シートが見つかりません」エラー

**原因**: 必要なシートが存在しない

**対処法**: スプレッドシートに以下のシートを作成
- T_棚卸履歴
- T_棚卸明細
- T_棚卸担当者別入力
- T_在庫
- T_入出庫履歴
- M_ユーザー
- M_製品
- M_保管場所

### ログイン画面から進めない

**原因**: M_ユーザーテーブルにメールアドレスが登録されていない

**対処法**: 
1. スプレッドシートのM_ユーザーシートを開く
2. 自分のGoogleアカウントのメールアドレスを登録
3. 「有効」列をTRUEに設定

### ページ遷移ができない（空白画面）

**原因**: `getScriptUrl()`が正しく動作していない

**対処法**:
1. ブラウザのコンソール（F12）でエラーを確認
2. デプロイURLを再確認
3. 再デプロイを実施

### 在庫数が合わない

**原因**: 棚卸確定時の在庫調整ログが正しく記録されていない

**対処法**:
1. T_入出庫履歴シートで「棚卸調整」タイプのレコードを確認
2. 必要に応じて手動で調整

## 📊 画面フロー図

```
[ログイン画面]
      ↓
[ホーム画面] ─┬─→ [入出庫登録]
              ├─→ [棚卸カウント入力]
              ├─→ [在庫一覧・検索]
              │
              └─→ [管理者専用]
                      ├─→ [棚卸照合・確定]
                      └─→ [マスタ管理]
```

## 📈 今後の拡張案

- [ ] CSVエクスポート機能
- [ ] 在庫アラート機能（最低在庫数の設定）
- [ ] バーコードスキャン対応
- [ ] ダッシュボード機能（在庫推移グラフ）
- [ ] 承認フロー機能
- [ ] モバイルアプリ化

## 📄 ライセンス

このプロジェクトは内部使用を想定しています。

## 🤝 サポート

質問や不具合報告は、プロジェクト管理者までお問い合わせください。

---

**作成者**: PromptSmith  
**最終更新**: 2025年11月  
**バージョン**: 1.0.0
