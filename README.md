# 在庫管理システム (Inventory Management System)

Google Apps Scriptで構築された、スプレッドシートをデータベースとして使用する在庫管理Webアプリケーションです。

## 📋 目次

- [概要](#概要)
- [主要機能](#主要機能)
- [システム構成](#システム構成)
- [セットアップ手順](#セットアップ手順)
- [使い方](#使い方)
- [データベース設計](#データベース設計)
- [技術スタック](#技術スタック)
- [開発者向け情報](#開発者向け情報)

## 🎯 概要

このシステムは、製造業や倉庫業向けの在庫管理を効率化するために開発されたWebアプリケーションです。入出庫管理、棚卸業務、在庫照会などの基本機能を備え、モバイルデバイスからでもアクセス可能です。

### 主な特徴

- ✅ **Googleアカウント認証** - セキュアなログイン
- ✅ **役割ベースアクセス制御** - 管理者と現場担当者で機能制限
- ✅ **モバイル対応** - レスポンシブデザイン
- ✅ **リアルタイム在庫管理** - 入出庫時に自動更新
- ✅ **複数担当者による棚卸** - カウント照合機能
- ✅ **カテゴリ階層による製品分類** - 2階層カテゴリ

## 🚀 主要機能

### 1. 入出庫登録
- 製品の入庫・出庫を記録
- カテゴリによる製品絞り込み
- 出庫時の在庫数確認と不足チェック
- 現場名の記録（出庫時）

### 2. 棚卸管理
#### カウント入力（現場担当者）
- 棚卸イベント単位での管理
- 製品ごと・保管場所ごとのカウント入力
- 自分の入力履歴確認

#### 照合・確定（管理者）
- 棚卸イベント作成
- 複数担当者のカウント照合
- 差異確認と理由入力
- 棚卸確定による在庫数自動調整

### 3. 在庫照会
- 全在庫一覧表示
- 製品ID・製品名での検索
- 製品別集計（保管場所別内訳付き）
- 保管場所別集計（製品リスト付き）

### 4. マスタ管理（管理者専用）
- **製品マスタ**: 製品の登録・編集・無効化
- **ユーザーマスタ**: ユーザーと権限の管理
- **保管場所マスタ**: 倉庫・保管場所の管理

## 🏗️ システム構成

```
┌─────────────────────────────────────────┐
│          フロントエンド                   │
│  HTML + Tailwind CSS + JavaScript       │
└─────────────────────────────────────────┘
                   ↕
┌─────────────────────────────────────────┐
│      Google Apps Script (Backend)       │
│  - 認証・認可                            │
│  - ビジネスロジック                       │
│  - データアクセス層                       │
└─────────────────────────────────────────┘
                   ↕
┌─────────────────────────────────────────┐
│      Google スプレッドシート (DB)         │
│  - マスタテーブル（M_xxx）               │
│  - トランザクションテーブル（T_xxx）      │
└─────────────────────────────────────────┘
```

### ファイル構成

```
.
├── Code.gs                    # メインエントリーポイント
├── ServerSide.gs              # サーバーサイドロジック
├── Common.html                # 共通CSS/JavaScript
├── Index.html                 # ログイン画面
├── HomeAdmin.html             # 管理者ホーム画面
├── HomeUser.html              # 現場担当者ホーム画面
├── StockMovement.html         # 入出庫登録画面
├── InventoryCount.html        # 棚卸カウント入力画面
├── InventoryVerify.html       # 棚卸照合・確定画面
├── StockList.html             # 在庫一覧・検索画面
├── MasterManagement.html      # マスタ管理画面
├── appsscript.json            # GAS設定ファイル
└── README.md                  # このファイル
```

## 📦 セットアップ手順

### 1. Googleスプレッドシートの準備

新規スプレッドシートを作成し、以下のシートを作成してください。

#### M_製品（製品マスタ）
| 製品ID | 製品名 | カテゴリ1 | カテゴリ2 | 単価 | 有効 |
|--------|--------|----------|----------|------|------|
| P001   | 製品A  | 部品     | ネジ     | 100  | TRUE |

#### M_ユーザー（ユーザーマスタ）
| ユーザーID | 部門 | ユーザー名 | メールアドレス | 権限 | 有効 |
|-----------|------|-----------|---------------|------|------|
| U001      | 倉庫 | 山田太郎   | yamada@example.com | 管理者 | TRUE |

#### M_保管場所（保管場所マスタ）
| 保管場所ID | 場所名 |
|-----------|--------|
| L001      | 第一倉庫 |

#### T_在庫（在庫テーブル）
| 在庫ID | 製品ID | 保管場所ID | 現在在庫数 | 最終更新日時 |
|--------|--------|-----------|-----------|-------------|
| S001   | P001   | L001      | 100       | 2024-01-01 |

#### T_入出庫履歴（入出庫履歴テーブル）
| 履歴ID | 製品ID | 数量 | 入出庫タイプ | 現場名 | 発生日時 | 操作ユーザーID | 保管場所ID |
|--------|--------|------|-------------|--------|----------|---------------|-----------|

#### T_棚卸履歴（棚卸履歴テーブル）
| 棚卸ID | 棚卸実施日 | ステータス | 担当ユーザーID |
|--------|-----------|----------|---------------|

#### T_棚卸明細（棚卸明細テーブル）
| 棚卸明細ID | 棚卸ID | 製品ID | 保管場所ID | 理論在庫数 | 確定実在庫数 | 差異 | 差異理由 |
|-----------|--------|--------|-----------|-----------|-------------|------|---------|

#### T_棚卸担当者別入力（棚卸担当者別入力テーブル）
| 入力ID | 棚卸ID | 担当ユーザーID | 製品ID | 保管場所ID | カウント数 | 入力日時 |
|--------|--------|---------------|--------|-----------|-----------|----------|

### 2. Google Apps Scriptプロジェクトの作成

1. スプレッドシートから「拡張機能」→「Apps Script」を開く
2. すべての`.gs`ファイルと`.html`ファイルをコピー＆ペースト
3. `appsscript.json`の内容も設定

### 3. スクリプトプロパティの設定（オプション）

別のスプレッドシートをデータベースとして使用する場合：

1. Apps Scriptエディタで「プロジェクトの設定」を開く
2. 「スクリプト プロパティ」に追加:
   - キー: `SPREADSHEET_ID`
   - 値: スプレッドシートのID

### 4. デプロイ

1. Apps Scriptエディタで「デプロイ」→「新しいデプロイ」
2. 種類: 「ウェブアプリ」を選択
3. 設定:
   - 説明: 任意
   - 次のユーザーとして実行: **ユーザー アクセス**
   - アクセスできるユーザー: **全員** または 組織内のユーザーのみ
4. デプロイ後、URLをコピー

### 5. 初期ユーザーの登録

M_ユーザーシートに、自分のGoogleアカウントのメールアドレスで管理者ユーザーを登録してください。

## 📱 使い方

### ログイン

1. デプロイしたWebアプリのURLにアクセス
2. Googleアカウントで自動ログイン
3. M_ユーザーに登録されているユーザーのみアクセス可能

### 入出庫登録

1. ホーム画面から「入出庫登録」を選択
2. 操作タイプ（入庫/出庫）を選択
3. 保管場所、製品、数量を入力
4. 出庫の場合は現場名も入力
5. 「登録」ボタンで確定

### 棚卸業務

#### 管理者: イベント作成
1. 「棚卸照合・確定」画面を開く
2. イベント名を入力して「イベント作成」
3. 現在の在庫状況のスナップショットが作成される

#### 現場担当者: カウント入力
1. 「棚卸カウント入力」画面を開く
2. 棚卸イベントを選択
3. 製品と保管場所を選択してカウント数を入力
4. 「自分の入力履歴」で確認可能

#### 管理者: 照合・確定
1. 「棚卸照合・確定」画面で棚卸イベントを選択
2. 「照合実行」で担当者間のカウント不一致を確認
3. 「明細表示」で詳細を確認し、確定実在庫数を入力
4. 「棚卸を確定する」で在庫を自動調整

### 在庫照会

1. 「在庫一覧・検索」画面を開く
2. 「全在庫表示」「製品別集計」「保管場所別集計」から選択
3. 検索フォームで製品ID・製品名での絞り込み可能

## 💾 データベース設計

### マスタテーブル

#### M_製品
製品情報を管理
- PK: 製品ID

#### M_ユーザー
ユーザーと権限を管理
- PK: ユーザーID
- UK: メールアドレス
- 権限: 「管理者」または「現場担当」

#### M_保管場所
倉庫・保管場所を管理
- PK: 保管場所ID

### トランザクションテーブル

#### T_在庫
現在の在庫数を保持
- PK: 在庫ID
- UK: (製品ID, 保管場所ID)

#### T_入出庫履歴
すべての入出庫記録を保持
- PK: 履歴ID
- 入出庫タイプ: 「入庫」「出庫」「棚卸調整(入庫)」「棚卸調整(出庫)」

#### T_棚卸履歴
棚卸イベントを管理
- PK: 棚卸ID
- ステータス: 「実施中」「照合中」「確定済」

#### T_棚卸明細
棚卸対象の明細
- PK: 棚卸明細ID
- FK: 棚卸ID

#### T_棚卸担当者別入力
担当者が入力したカウント数
- PK: 入力ID
- FK: 棚卸ID, 担当ユーザーID

## 🛠️ 技術スタック

- **フロントエンド**:
  - HTML5
  - Tailwind CSS (CDN)
  - Vanilla JavaScript
  
- **バックエンド**:
  - Google Apps Script (JavaScript V8 Runtime)
  
- **データベース**:
  - Google スプレッドシート
  
- **認証**:
  - Google アカウント (OAuth)
  
- **ホスティング**:
  - Google Apps Script Web App

## 👨‍💻 開発者向け情報

### 主要関数

#### 認証・認可
- `getCurrentUser()`: 現在ログイン中のユーザー情報を取得
- `checkUserPermission(requiredRole)`: 権限チェック
- `requireAdminPermission()`: 管理者権限必須チェック

#### 入出庫管理
- `registerStockMovement(data)`: 入出庫登録
- `updateStock(productId, locationId, quantity, type)`: 在庫更新

#### 棚卸管理
- `createInventoryEvent(eventName)`: 棚卸イベント作成
- `registerInventoryCount(data)`: カウント入力
- `verifyInventoryCounts(inventoryId)`: 照合
- `finalizeInventory(inventoryId, details)`: 確定

#### 在庫照会
- `getAllStocks()`: 全在庫取得
- `searchStocks(query)`: 在庫検索
- `getStocksByProduct()`: 製品別集計
- `getStocksByLocation()`: 保管場所別集計

### エラーハンドリング

すべてのシート取得処理でnullチェックを実施し、シートが存在しない場合は適切なエラーメッセージを表示します。

```javascript
const sheet = ss.getSheetByName('M_製品');
if (!sheet) {
  throw new Error('M_製品シートが見つかりません。スプレッドシートの設定を確認してください。');
}
```

### デバッグ

Google Apps Scriptエディタの「実行ログ」でログを確認できます。

```javascript
Logger.log('デバッグメッセージ');
```

## 📝 ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 🤝 コントリビューション

バグ報告や機能リクエストは、Issuesでお願いします。

## 📞 サポート

質問や問題がある場合は、開発者に連絡してください。

---

**開発**: PromptSmith  
**最終更新**: 2024年11月
