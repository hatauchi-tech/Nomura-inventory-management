<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>éå»ãƒ‡ãƒ¼ã‚¿èª¿æ•´ - åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <?!= include('Common'); ?>
</head>
<body class="bg-gray-100">
  <div class="min-h-screen py-6 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto">
      <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
      <div class="bg-white shadow rounded-lg p-6 mb-6 mobile-header">
        <div class="flex justify-between items-center">
          <h1 class="text-2xl font-bold text-gray-900 page-title">éå»ãƒ‡ãƒ¼ã‚¿èª¿æ•´</h1>
          <button onclick="goHome()" class="bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600">
            ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
          </button>
        </div>
        <p class="mt-2 text-sm text-gray-600">
          éå»3ãƒ¶æœˆä»¥å†…ã®å…¥å‡ºåº«å±¥æ­´ã‚’è¿½åŠ ç™»éŒ²ã§ãã¾ã™ã€‚<br>
          <span class="text-red-600 font-semibold">â€» æ³¨æ„: ã“ã®æ“ä½œã¯ç¾åœ¨ã®åœ¨åº«æ•°ã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“ã€‚ç†è«–åœ¨åº«ã®è¨˜éŒ²ã®ã¿è¿½åŠ ã•ã‚Œã¾ã™ã€‚</span>
        </p>
      </div>

      <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
      <div id="success-message" class="hidden bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
        <p class="text-green-700"></p>
      </div>
      <div id="error-message" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
        <p class="text-red-700"></p>
      </div>

      <!-- ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">éå»ãƒ‡ãƒ¼ã‚¿ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ </h2>

        <form id="past-movement-form" class="space-y-4">
          <!-- å…¥å‡ºåº«ã‚¿ã‚¤ãƒ— -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">å…¥å‡ºåº«ã‚¿ã‚¤ãƒ— <span class="text-red-500">*</span></label>
            <select id="movement-type" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="å…¥åº«">å…¥åº«</option>
              <option value="å‡ºåº«">å‡ºåº«</option>
            </select>
          </div>

          <!-- ç™ºç”Ÿæ—¥æ™‚ -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ç™ºç”Ÿæ—¥æ™‚ <span class="text-red-500">*</span></label>
            <input type="date" id="occurrence-date" required
                   class="w-full px-3 py-2 border border-gray-300 rounded-md">
            <p class="mt-1 text-xs text-gray-500">éå»3ãƒ¶æœˆä»¥å†…ã®æ—¥ä»˜ã‚’æŒ‡å®šã—ã¦ãã ã•ã„</p>
          </div>

          <!-- ä¿ç®¡å ´æ‰€ -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ä¿ç®¡å ´æ‰€ <span class="text-red-500">*</span></label>
            <select id="location-select" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>

          <!-- ã‚«ãƒ†ã‚´ãƒª1 -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ã‚«ãƒ†ã‚´ãƒª1 <span class="text-red-500">*</span></label>
            <select id="category1-select" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>

          <!-- ã‚«ãƒ†ã‚´ãƒª2 -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ã‚«ãƒ†ã‚´ãƒª2 <span class="text-red-500">*</span></label>
            <select id="category2-select" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>

          <!-- è£½å“ -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">è£½å“ <span class="text-red-500">*</span></label>
            <select id="product-select" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>

          <!-- æ•°é‡ -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">æ•°é‡ <span class="text-red-500">*</span></label>
            <input type="number" id="quantity-input" min="1" required
                   class="w-full px-3 py-2 border border-gray-300 rounded-md"
                   placeholder="æ•°é‡ã‚’å…¥åŠ›">
          </div>

          <!-- ç¾å ´å -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ç¾å ´å</label>
            <input type="text" id="site-name-input"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md"
                   placeholder="å‡ºåº«å…ˆç¾å ´åï¼ˆä»»æ„ï¼‰">
          </div>

          <!-- å®¢å…ˆ -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">å®¢å…ˆ</label>
            <input type="text" id="customer-name-input"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md"
                   placeholder="é¡§å®¢åï¼ˆä»»æ„ï¼‰">
          </div>

          <!-- å‚™è€ƒ -->
          <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <p class="text-sm text-yellow-800">
              <strong>ğŸ“Œ é‡è¦ãªæ³¨æ„äº‹é …:</strong><br>
              â€¢ ã“ã®ç™»éŒ²ã¯å±¥æ­´ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ã¿è¿½åŠ ã•ã‚Œã€ç¾åœ¨ã®åœ¨åº«æ•°ã¯å¤‰æ›´ã•ã‚Œã¾ã›ã‚“<br>
              â€¢ æ£šå¸å¾Œã®ç†è«–åœ¨åº«èª¿æ•´ãªã©ã€éå»ã®è¨˜éŒ²æ¼ã‚Œã‚’è£œæ­£ã™ã‚‹ç›®çš„ã§ä½¿ç”¨ã—ã¦ãã ã•ã„<br>
              â€¢ å±¥æ­´ãƒ¬ã‚³ãƒ¼ãƒ‰ã«ã¯ã€Œ(éå»èª¿æ•´)ã€ã¨ã„ã†ãƒ©ãƒ™ãƒ«ãŒä»˜ãã¾ã™
            </p>
          </div>

          <!-- ãƒœã‚¿ãƒ³ -->
          <div class="flex space-x-4">
            <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
              ç™»éŒ²ã™ã‚‹
            </button>
            <button type="reset" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400">
              ã‚¯ãƒªã‚¢
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    let locations = [];
    let categories1 = [];
    let categories2 = [];
    let products = [];

    // åˆæœŸåŒ–
    window.addEventListener('load', function() {
      loadStorageLocations();
      loadCategory1List();
      setMaxDate();
    });

    // æ—¥ä»˜ã®æœ€å¤§å€¤ã‚’ä»Šæ—¥ã«è¨­å®š
    function setMaxDate() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('occurrence-date').setAttribute('max', today);

      // 3ãƒ¶æœˆå‰ã®æ—¥ä»˜ã‚’æœ€å°å€¤ã«è¨­å®š
      const threeMonthsAgo = new Date();
      threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
      const minDate = threeMonthsAgo.toISOString().split('T')[0];
      document.getElementById('occurrence-date').setAttribute('min', minDate);
    }

    // ä¿ç®¡å ´æ‰€ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    function loadStorageLocations() {
      google.script.run
        .withSuccessHandler(function(data) {
          locations = data;
          const select = document.getElementById('location-select');
          data.forEach(item => {
            const option = document.createElement('option');
            option.value = item['ä¿ç®¡å ´æ‰€ID'];
            option.textContent = item['å ´æ‰€å'];
            select.appendChild(option);
          });
        })
        .withFailureHandler(function(error) {
          showError('ä¿ç®¡å ´æ‰€ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        })
        .getStorageLocations();
    }

    // ã‚«ãƒ†ã‚´ãƒª1ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    function loadCategory1List() {
      google.script.run
        .withSuccessHandler(function(data) {
          categories1 = data;
          const select = document.getElementById('category1-select');
          data.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            select.appendChild(option);
          });
        })
        .withFailureHandler(function(error) {
          showError('ã‚«ãƒ†ã‚´ãƒª1ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        })
        .getCategory1List();
    }

    // ã‚«ãƒ†ã‚´ãƒª1é¸æŠæ™‚
    document.getElementById('category1-select').addEventListener('change', function() {
      const category1 = this.value;
      const category2Select = document.getElementById('category2-select');
      const productSelect = document.getElementById('product-select');

      category2Select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
      productSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';

      if (!category1) return;

      google.script.run
        .withSuccessHandler(function(data) {
          categories2 = data;
          data.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            category2Select.appendChild(option);
          });
        })
        .withFailureHandler(function(error) {
          showError('ã‚«ãƒ†ã‚´ãƒª2ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        })
        .getCategory2List(category1);
    });

    // ã‚«ãƒ†ã‚´ãƒª2é¸æŠæ™‚
    document.getElementById('category2-select').addEventListener('change', function() {
      const category1 = document.getElementById('category1-select').value;
      const category2 = this.value;
      const productSelect = document.getElementById('product-select');

      productSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';

      if (!category2) return;

      google.script.run
        .withSuccessHandler(function(data) {
          products = data;
          data.forEach(item => {
            const option = document.createElement('option');
            option.value = item['è£½å“ID'];
            option.textContent = item['è£½å“å'];
            productSelect.appendChild(option);
          });
        })
        .withFailureHandler(function(error) {
          showError('è£½å“ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        })
        .getProductsByCategory(category1, category2);
    });

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    document.getElementById('past-movement-form').addEventListener('submit', function(e) {
      e.preventDefault();
      hideMessages();

      const data = {
        type: document.getElementById('movement-type').value,
        occurrenceDate: document.getElementById('occurrence-date').value,
        locationId: document.getElementById('location-select').value,
        productId: document.getElementById('product-select').value,
        quantity: document.getElementById('quantity-input').value,
        siteName: document.getElementById('site-name-input').value,
        customerName: document.getElementById('customer-name-input').value
      };

      if (confirm('éå»ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã€‚ç¾åœ¨ã®åœ¨åº«æ•°ã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“ãŒã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
        showLoading();
        google.script.run
          .withSuccessHandler(function(result) {
            hideLoading();
            if (result.success) {
              showSuccess(result.message + '\n' + (result.warning || ''));
              document.getElementById('past-movement-form').reset();
            } else {
              showError(result.error);
            }
          })
          .withFailureHandler(function(error) {
            hideLoading();
            showError('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          })
          .registerPastStockMovement(data);
      }
    });
  </script>
</body>
</html>
