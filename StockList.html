<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>在庫一覧・検索</title>
  <?!= include('Common'); ?>
</head>
<body class="bg-gray-100">
  <header class="bg-white shadow-md mobile-header">
    <div class="container mx-auto px-3 sm:px-4 py-3 sm:py-4">
      <div class="flex items-center justify-between">
        <h1 class="text-lg sm:text-xl font-bold text-gray-900">在庫管理システム</h1>
        <button onclick="goHome()"
                class="bg-blue-600 text-white px-3 sm:px-4 py-2 rounded-md hover:bg-blue-700 text-sm sm:text-base">
          ホーム
        </button>
      </div>
    </div>
  </header>

  <div class="container mx-auto px-3 sm:px-4 py-4 sm:py-8">
    <div class="mb-4 sm:mb-8">
      <h1 class="text-xl sm:text-3xl font-bold text-gray-900 page-title">在庫一覧・検索</h1>
    </div>

    <!-- 表示タイプ選択 -->
    <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 mb-4 sm:mb-6">
      <div class="flex flex-wrap gap-2 sm:space-x-4 sm:gap-0">
        <button onclick="showAllStocks()" 
                class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
          全在庫表示
        </button>
        <button onclick="showStocksByProduct()" 
                class="flex-1 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">
          製品別集計
        </button>
        <button onclick="showStocksByLocation()" 
                class="flex-1 bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700">
          保管場所別集計
        </button>
      </div>
    </div>
    
    <!-- 検索フォーム (修正) -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">在庫検索</h2>
      <!-- ★★★ フォームのレイアウトと項目を修正 ★★★ -->
      <form id="search-form" class="grid grid-cols-1 md:grid-cols-4 gap-4">
        
        <!-- カテゴリ1 -->
        <select id="search-category1" name="category1"
                class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">カテゴリ1（すべて）</option>
        </select>
        
        <!-- カテゴリ2 -->
        <select id="search-category2" name="category2"
                class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">カテゴリ2（すべて）</option>
        </select>
        
        <!-- 製品名 -->
        <input type="text" id="search-product-name" name="productName"
               class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
               placeholder="製品名（部分一致）">
        
        <!-- 製品ID (削除) -->
        
        <button type="submit"
                class="bg-yellow-600 text-white py-2 px-4 rounded-md hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          検索
        </button>
      </form>
    </div>
    
    <!-- メッセージ表示エリア -->
    <div id="error-message" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
      <p class="text-sm text-red-700"></p>
    </div>
    
    <!-- 結果表示エリア -->
    <div id="result-area" class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">検索結果</h2>
      <div id="result-content" class="text-gray-500 text-center py-8">
        上のボタンから表示方法を選択してください
      </div>
    </div>
  </div>

  <script>
    window.addEventListener('load', function() {
      document.getElementById('search-form').addEventListener('submit', handleSearch);
      
      // カテゴリ1のドロップダウンを初期化
      loadCategory1List(); 
      
      // カテゴリ1の変更イベントリスナー
      document.getElementById('search-category1').addEventListener('change', handleCategory1Change);
    });
    
    // カテゴリ1リストを読み込む
    function loadCategory1List() {
      google.script.run
        .withSuccessHandler(function(data) {
          const select = document.getElementById('search-category1');
          data.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            select.appendChild(option);
          });
        })
        .withFailureHandler(showError)
        .getCategory1List(); // ServerSide.gsの既存関数を再利用
    }
    
    // カテゴリ1変更時にカテゴリ2を読み込む
    function handleCategory1Change() {
      const category1 = document.getElementById('search-category1').value;
      const category2Select = document.getElementById('search-category2');
      
      category2Select.innerHTML = '<option value="">カテゴリ2（すべて）</option>'; // リセット
      
      if (category1) {
        google.script.run
          .withSuccessHandler(function(data) {
            data.forEach(cat => {
              const option = document.createElement('option');
              option.value = cat;
              option.textContent = cat;
              category2Select.appendChild(option);
            });
          })
          .withFailureHandler(showError)
          .getCategory2List(category1); // ServerSide.gsの既存関数を再利用
      }
    }
    
    function showAllStocks() {
      hideMessages();
      showLoading();
      
      google.script.run
        .withSuccessHandler(function(data) {
          hideLoading();
          displayAllStocks(data);
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showError('在庫データの取得に失敗しました: ' + error.message);
        })
        .getAllStocks();
    }
    
    function displayAllStocks(data) {
      const content = document.getElementById('result-content');

      if (!data || !Array.isArray(data) || data.length === 0) {
        content.innerHTML = '<p class="text-gray-500 text-center py-8">在庫データがありません</p>';
        return;
      }
      
      content.innerHTML = `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>製品ID</th>
                <th>製品名</th>
                <th>カテゴリ1</th>
                <th>カテゴリ2</th>
                <th>保管場所</th>
                <th>在庫数</th>
                <th>最終更新</th>
              </tr>
            </thead>
            <tbody>
              ${data.map(item => {
                const currentStock = Number(item['現在在庫数'] || 0);
                const optimalStock = Number(item['適正在庫数'] || 0);
                const isLowStock = optimalStock > 0 && currentStock < optimalStock;

                return `
                <tr ${isLowStock ? 'class="bg-yellow-50"' : ''}>
                  <td>${item['製品ID']}</td>
                  <td>${item['製品名']}</td>
                  <td>${item['カテゴリ1']}</td>
                  <td>${item['カテゴリ2']}</td>
                  <td>${item['場所名']}</td>
                  <td class="font-semibold">
                    ${isLowStock ? '<span class="text-red-600">⚠️ </span>' : ''}
                    ${formatNumber(currentStock)}
                    ${optimalStock > 0 ? `<span class="text-gray-500 text-sm ml-1">(適正: ${formatNumber(optimalStock)})</span>` : ''}
                  </td>
                  <td>${formatDateTime(item['最終更新日時'])}</td>
                </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
    }
    
    function showStocksByProduct() {
      hideMessages();
      showLoading();
      
      google.script.run
        .withSuccessHandler(function(data) {
          hideLoading();
          displayStocksByProduct(data);
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showError('集計データの取得に失敗しました: ' + error.message);
        })
        .getStocksByProduct();
    }
    
    function displayStocksByProduct(data) {
      const content = document.getElementById('result-content');

      if (!data || !Array.isArray(data) || data.length === 0) {
        content.innerHTML = '<p class="text-gray-500 text-center py-8">在庫データがありません</p>';
        return;
      }
      
      content.innerHTML = `
        <div class="space-y-4">
          ${data.map(item => `
            <div class="border border-gray-300 rounded-lg p-4">
              <div class="flex justify-between items-center mb-2">
                <div>
                  <h3 class="font-semibold text-lg">${item['製品ID']} - ${item['製品名']}</h3>
                  <p class="text-sm text-gray-600">${item['カテゴリ1']} / ${item['カテゴリ2']}</p>
                </div>
                <div class="text-right">
                  <p class="text-2xl font-bold text-blue-600">${formatNumber(item['総在庫数'])}</p>
                  <p class="text-sm text-gray-500">総在庫数</p>
                </div>
              </div>
              <div class="mt-3 pt-3 border-t border-gray-200">
                <p class="text-sm font-semibold text-gray-700 mb-2">保管場所別内訳:</p>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                  ${item['保管場所'].map(loc => `
                    <div class="bg-gray-50 px-3 py-2 rounded">
                      <p class="text-sm">${loc['場所名']}</p>
                      <p class="font-semibold">${formatNumber(loc['在庫数'])}</p>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    function showStocksByLocation() {
      hideMessages();
      showLoading();
      
      google.script.run
        .withSuccessHandler(function(data) {
          hideLoading();
          displayStocksByLocation(data);
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showError('集計データの取得に失敗しました: ' + error.message);
        })
        .getStocksByLocation();
    }
    
    function displayStocksByLocation(data) {
      const content = document.getElementById('result-content');

      if (!data || !Array.isArray(data) || data.length === 0) {
        content.innerHTML = '<p class="text-gray-500 text-center py-8">在庫データがありません</p>';
        return;
      }
      
      content.innerHTML = `
        <div class="space-y-4">
          ${data.map(item => `
            <div class="border border-gray-300 rounded-lg p-4">
              <div class="flex justify-between items-center mb-3">
                <h3 class="font-semibold text-lg">${item['保管場所ID']} - ${item['場所名']}</h3>
                <p class="text-sm text-gray-600">${item['製品数']} 品目</p>
              </div>
              <div class="table-container">
                <table class="text-sm">
                  <thead>
                    <tr>
                      <th>製品ID</th>
                      <th>製品名</th>
                      <th>在庫数</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${item['製品リスト'].map(prod => `
                      <tr>
                        <td>${prod['製品ID']}</td>
                        <td>${prod['製品名']}</td>
                        <td class="font-semibold">${formatNumber(prod['在庫数'])}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    // ★★★ 検索処理 (修正) ★★★
    function handleSearch(e) {
      e.preventDefault();
      hideMessages();
      
      const formData = new FormData(e.target);
      const query = {
        // productId: formData.get('productId'), // (削除)
        productName: formData.get('productName'),
        category1: formData.get('category1'),
        category2: formData.get('category2')
      };
      
      // (修正) 検索条件がすべて空の場合に全件表示する
      if (!query.productName && !query.category1 && !query.category2) {
        showAllStocks();
        return;
      }
      
      showLoading();
      google.script.run
        .withSuccessHandler(function(data) {
          hideLoading();
          displayAllStocks(data);
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showError('検索に失敗しました: ' + error.message);
        })
        .searchStocks(query); // 修正済みのsearchStocksを呼び出す
    }
  </script>
</body>
</html>