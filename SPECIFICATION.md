# 在庫管理システム 仕様書

## 目次

1. [システム概要](#1-システム概要)
2. [機能仕様](#2-機能仕様)
3. [画面仕様](#3-画面仕様)
4. [データ仕様](#4-データ仕様)
5. [API仕様](#5-api仕様)
6. [セキュリティ仕様](#6-セキュリティ仕様)
7. [非機能要件](#7-非機能要件)

---

## 1. システム概要

### 1.1 システム名

在庫管理システム

### 1.2 目的

製品の入出庫管理、棚卸業務、在庫照会をWebブラウザから行えるようにし、在庫管理業務の効率化と正確性向上を図る。

### 1.3 システム構成

```
┌─────────────────────────────────────────────────────────────┐
│                      クライアント                            │
│  ┌─────────────────────────────────────────────────────┐   │
│  │           Webブラウザ（Chrome/Edge/Safari）          │   │
│  │  ┌─────────────────────────────────────────────┐   │   │
│  │  │  HTML + JavaScript + Tailwind CSS          │   │   │
│  │  └─────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ HTTPS
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   Google Cloud Platform                      │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Google Apps Script (V8)                │   │
│  │  ┌─────────────┐  ┌─────────────────────────────┐  │   │
│  │  │  Code.gs    │  │     ServerSide.gs           │  │   │
│  │  │ (ルーティング) │  │  (ビジネスロジック)          │  │   │
│  │  └─────────────┘  └─────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────┘   │
│                              │                              │
│                              ▼                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Google Spreadsheet                     │   │
│  │         （データベースとして使用）                    │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 1.4 技術スタック

| レイヤー | 技術 |
|---------|------|
| フロントエンド | HTML5, JavaScript (ES6+), Tailwind CSS |
| バックエンド | Google Apps Script (V8 Runtime) |
| データベース | Google Spreadsheet |
| 認証 | Google Account Authentication |
| ホスティング | Google Apps Script Web App |

---

## 2. 機能仕様

### 2.1 機能一覧

| 機能ID | 機能名 | 概要 | 権限 |
|--------|--------|------|------|
| F001 | ログイン | Googleアカウント認証 | 全員 |
| F002 | 入庫登録 | 製品の入庫を記録 | 管理者 |
| F003 | 出庫登録 | 製品の出庫を記録 | 全員 |
| F004 | 入出庫履歴確認 | 履歴の確認・編集・削除 | 全員（自分）/管理者（全員） |
| F005 | 製品変更 | 入出庫履歴の製品を変更 | 全員（自分）/管理者（全員） |
| F006 | 棚卸イベント作成 | 棚卸を開始 | 管理者 |
| F007 | 棚卸カウント入力 | 実在庫をカウント入力 | 全員 |
| F008 | 棚卸照合 | 複数担当者のカウント照合 | 管理者 |
| F009 | 棚卸確定 | 在庫を確定値に更新 | 管理者 |
| F010 | 在庫検索 | 在庫の検索・表示 | 全員 |
| F011 | 製品マスタ管理 | 製品の登録・編集・削除 | 管理者 |
| F012 | ユーザーマスタ管理 | ユーザーの登録・編集・削除 | 管理者 |
| F013 | 保管場所マスタ管理 | 保管場所の登録・編集・削除 | 管理者 |
| F014 | 適正在庫アラート | 在庫が適正在庫数を下回った際にメール通知 | 自動 |
| F015 | 過去データ調整 | 過去3ヶ月以内の履歴を補正登録 | 管理者 |

### 2.2 機能詳細

#### F001: ログイン

**概要**: Googleアカウントによる認証を行い、システムにアクセスする

**処理フロー**:
1. ユーザーがシステムURLにアクセス
2. Googleアカウントで認証
3. M_ユーザーテーブルでメールアドレスを照合
4. 登録済み・有効の場合、権限に応じたホーム画面へ遷移
5. 未登録または無効の場合、エラー表示

**入力**: なし（Google認証情報）

**出力**: ホーム画面への遷移

---

#### F002: 入庫登録

**概要**: 製品の入庫を記録し、在庫を増加させる

**処理フロー**:
1. 保管場所を選択
2. カテゴリ1→カテゴリ2→製品を選択
3. 数量を入力
4. 登録実行
5. T_入出庫履歴に記録追加
6. T_在庫を更新（在庫増加）

**入力**:
| 項目 | 必須 | 型 | 説明 |
|------|------|-----|------|
| 保管場所ID | ○ | 文字列 | 保管場所 |
| 製品ID | ○ | 数値 | 製品 |
| 数量 | ○ | 数値 | 入庫数量（1以上） |

**出力**: 成功/失敗メッセージ

**バリデーション**:
- 数量は1以上の整数
- 管理者権限必須

---

#### F003: 出庫登録

**概要**: 製品の出庫を記録し、在庫を減少させる

**処理フロー**:
1. 保管場所を選択
2. カテゴリ1→カテゴリ2→製品を選択
3. 数量を入力
4. 現場名・客先を入力（任意）
5. 現在在庫数を確認
6. 登録実行
7. T_入出庫履歴に記録追加
8. T_在庫を更新（在庫減少）

**入力**:
| 項目 | 必須 | 型 | 説明 |
|------|------|-----|------|
| 保管場所ID | ○ | 文字列 | 保管場所 |
| 製品ID | ○ | 数値 | 製品 |
| 数量 | ○ | 数値 | 出庫数量（1以上） |
| 現場名 | - | 文字列 | 出荷先現場名 |
| 客先 | - | 文字列 | 顧客名 |

**出力**: 成功/失敗メッセージ

**バリデーション**:
- 数量は1以上の整数
- 数量は現在在庫数以下

---

#### F004: 入出庫履歴確認

**概要**: 入出庫履歴の確認・編集・削除を行う

**処理フロー**:
1. 絞り込み条件を設定
2. 履歴一覧を取得・表示
3. 編集: 数量・現場名・客先を変更 → 在庫自動連動
4. 削除: 履歴削除 → 在庫を元に戻す

**絞り込み条件**:
| 項目 | 型 | 説明 |
|------|-----|------|
| 入出庫タイプ | 文字列 | 入庫/出庫/全て |
| 保管場所ID | 文字列 | 保管場所 |
| カテゴリ1 | 文字列 | 大分類 |
| カテゴリ2 | 文字列 | 小分類 |
| 開始日 | 日付 | 期間開始 |
| 終了日 | 日付 | 期間終了 |
| 現場名 | 文字列 | 部分一致検索 |
| 客先 | 文字列 | 部分一致検索 |

**権限**:
- 一般ユーザー: 自分の履歴のみ
- 管理者: 全ユーザーの履歴

---

#### F005: 製品変更

**概要**: 入出庫履歴の製品を変更し、在庫を自動調整する

**処理フロー**:
1. 対象履歴を選択
2. 新しい製品を選択
3. 変更実行
4. 旧製品の在庫を戻す（入庫→減少、出庫→増加）
5. 新製品の在庫を更新（入庫→増加、出庫→減少）
6. T_入出庫履歴の製品IDを更新

**入力**:
| 項目 | 必須 | 型 | 説明 |
|------|------|-----|------|
| 履歴ID | ○ | 文字列 | 対象履歴 |
| 新製品ID | ○ | 数値 | 変更先製品 |

**バリデーション**:
- 出庫記録の場合、新製品の在庫が数量以上必要
- 自分の履歴または管理者権限必須

---

#### F007: 棚卸カウント入力

**概要**: 棚卸時に実在庫をカウントして入力する

**処理フロー**:
1. 棚卸イベントを選択
2. 保管場所を選択
3. 製品ごとにカウント数を入力
4. 一括登録実行
5. T_棚卸担当者別入力に記録

**入力形式**:
| パターン | 例 | 結果 |
|---------|-----|------|
| 単純数値 | `48` | 48 |
| 掛け算（全角×） | `48×18` | 864 |
| 掛け算（半角*） | `48*18` | 864 |
| 掛け算（小文字x） | `48x18` | 864 |
| マイナス値 | `-5` | -5 |

**バリデーション**:
- 同一製品の複数入力は合計される
- 合計がマイナスになる場合は登録不可
- 無効な入力形式はエラー表示

---

#### F014: 適正在庫アラート

**概要**: 出庫により在庫が適正在庫数を下回った場合、担当部署の管理者に自動でメール通知する

**処理フロー**:
1. 出庫登録実行
2. 在庫更新後の在庫数をチェック
3. 適正在庫数が設定されており、在庫数が適正在庫数を下回った場合
4. 製品の担当部署を取得
5. 担当部署の管理者（有効なユーザー）を検索
6. 各管理者にメール送信

**メール内容**:
- 件名: 【在庫アラート】適正在庫数を下回りました
- 本文: 製品名、製品ID、カテゴリ、保管場所、現在在庫数、適正在庫数、不足数、担当部署

**前提条件**:
- M_製品に適正在庫数が設定されている（0より大きい）
- M_製品に担当部署が設定されている
- M_ユーザーに該当部署の管理者が登録されている（有効、メールアドレス必須）

---

#### F015: 過去データ調整

**概要**: 過去3ヶ月以内の入出庫履歴を遡って登録する（理論在庫の補正用）

**処理フロー**:
1. 発生日時を指定（過去3ヶ月以内）
2. 保管場所、製品、数量、タイプを選択
3. 現場名・客先を入力（任意）
4. 登録実行
5. T_入出庫履歴に「入庫(過去調整)」または「出庫(過去調整)」として記録
6. **T_在庫は更新しない**（現在在庫に影響を与えない）

**入力**:
| 項目 | 必須 | 型 | 説明 |
|------|------|-----|------|
| 発生日時 | ○ | 日時 | 過去3ヶ月以内、未来日は不可 |
| 保管場所ID | ○ | 文字列 | 保管場所 |
| 製品ID | ○ | 数値 | 製品 |
| 数量 | ○ | 数値 | 入出庫数量（1以上） |
| タイプ | ○ | 文字列 | 入庫/出庫 |
| 現場名 | - | 文字列 | 出荷先現場名 |
| 客先 | - | 文字列 | 顧客名 |

**バリデーション**:
- 発生日時は過去3ヶ月以内
- 発生日時は未来日ではない
- 管理者権限必須

**注意事項**:
- この機能は現在の在庫数には影響を与えません
- 理論在庫の履歴を正確に保つための補正機能です
- 現在の在庫数を変更する場合は通常の入出庫登録を使用してください

---

## 3. 画面仕様

### 3.1 画面一覧

| 画面ID | 画面名 | ファイル | 説明 |
|--------|--------|---------|------|
| S001 | ログイン | Index.html | 初期画面・認証 |
| S002 | 管理者ホーム | HomeAdmin.html | 管理者用メニュー |
| S003 | ユーザーホーム | HomeUser.html | 一般ユーザー用メニュー |
| S004 | 入出庫登録 | StockMovement.html | 入庫・出庫登録 |
| S005 | 入出庫履歴 | StockMovementHistory.html | 履歴確認・編集・削除 |
| S006 | 棚卸カウント入力 | InventoryCount.html | 棚卸入力 |
| S007 | 棚卸照合・確定 | InventoryVerify.html | 照合・確定処理 |
| S008 | 在庫一覧 | StockList.html | 在庫検索・表示 |
| S009 | マスタ管理 | MasterManagement.html | 各種マスタ管理 |
| S010 | 過去データ調整 | PastStockAdjustment.html | 過去履歴の補正登録 |

### 3.2 画面遷移図

```
[S001: ログイン]
      │
      ├─── 管理者 ───→ [S002: 管理者ホーム]
      │                      │
      │                      ├→ [S004: 入出庫登録]
      │                      ├→ [S005: 入出庫履歴]
      │                      ├→ [S006: 棚卸カウント入力]
      │                      ├→ [S007: 棚卸照合・確定]
      │                      ├→ [S008: 在庫一覧]
      │                      ├→ [S009: マスタ管理]
      │                      └→ [S010: 過去データ調整]
      │
      └─── 一般 ────→ [S003: ユーザーホーム]
                            │
                            ├→ [S004: 入出庫登録]（出庫のみ）
                            ├→ [S005: 入出庫履歴]（自分のみ）
                            ├→ [S006: 棚卸カウント入力]
                            └→ [S008: 在庫一覧]
```

### 3.3 レスポンシブ対応

- Tailwind CSSによるレスポンシブデザイン
- ブレークポイント:
  - sm: 640px
  - md: 768px
  - lg: 1024px
- モバイル端末での操作を考慮したUI設計

---

## 4. データ仕様

### 4.1 テーブル一覧

| テーブル名 | 種別 | 説明 |
|-----------|------|------|
| M_ユーザー | マスタ | ユーザー情報 |
| M_製品 | マスタ | 製品情報 |
| M_保管場所 | マスタ | 保管場所情報 |
| T_在庫 | トランザクション | 現在在庫 |
| T_入出庫履歴 | トランザクション | 入出庫記録 |
| T_棚卸履歴 | トランザクション | 棚卸イベント |
| T_棚卸明細 | トランザクション | 棚卸詳細 |
| T_棚卸担当者別入力 | トランザクション | カウント入力 |

### 4.2 ER図

```
M_製品 ──────────< T_在庫 >───────── M_保管場所
   │                                      │
   │                                      │
   ├──────────< T_入出庫履歴 >────────────┤
   │                  │                   │
   │                  │                   │
   │             M_ユーザー               │
   │                  │                   │
   │                  │                   │
   ├──────────< T_棚卸明細 >──────────────┤
   │                  │                   │
   │                  │                   │
   │            T_棚卸履歴                │
   │                  │                   │
   │                  │                   │
   └──────────< T_棚卸担当者別入力 >──────┘
```

### 4.3 ID採番ルール

| テーブル | プレフィックス | 形式 | 例 |
|---------|--------------|------|-----|
| M_製品 | なし | 数値連番 | 1, 2, 3 |
| M_ユーザー | U | U + 3桁連番 | U001, U002 |
| M_保管場所 | P | P + 3桁連番 | P001, P002 |
| T_在庫 | S | S + タイムスタンプ + 3桁 | S17001234567890123 |
| T_入出庫履歴 | H | H + タイムスタンプ + 3桁 | H17001234567890456 |
| T_棚卸履歴 | I | I + タイムスタンプ + 3桁 | I17001234567890789 |
| T_棚卸明細 | ID | ID + タイムスタンプ + 3桁 | ID17001234567890012 |
| T_棚卸担当者別入力 | IC | IC + タイムスタンプ + 3桁 | IC17001234567890345 |

### 4.4 テーブル定義詳細

#### M_ユーザー

| # | 列名 | データ型 | NULL | PK | 説明 |
|---|------|---------|------|-----|------|
| 1 | ユーザーID | VARCHAR | NO | ○ | U+3桁連番 |
| 2 | 部門 | VARCHAR | YES | - | 所属部門 |
| 3 | ユーザー名 | VARCHAR | NO | - | 氏名 |
| 4 | メールアドレス | VARCHAR | NO | - | Googleアカウント（一意） |
| 5 | 権限 | VARCHAR | NO | - | 管理者/現場担当 |
| 6 | 有効 | BOOLEAN | NO | - | TRUE/FALSE |

#### M_製品

| # | 列名 | データ型 | NULL | PK | 説明 |
|---|------|---------|------|-----|------|
| 1 | 製品ID | INTEGER | NO | ○ | 数値連番 |
| 2 | 製品名 | VARCHAR | NO | - | 製品名称 |
| 3 | カテゴリ1 | VARCHAR | YES | - | 大分類 |
| 4 | カテゴリ2 | VARCHAR | YES | - | 小分類 |
| 5 | 有効 | BOOLEAN | NO | - | TRUE/FALSE |
| 6 | 単価 | NUMBER | YES | - | 製品単価 |
| 7 | 適正在庫数 | INTEGER | YES | - | 在庫アラート基準値（0または未設定の場合アラートなし） |
| 8 | 担当部署 | VARCHAR | YES | - | メール通知先の部署名（M_ユーザー.部門と照合） |

#### M_保管場所

| # | 列名 | データ型 | NULL | PK | 説明 |
|---|------|---------|------|-----|------|
| 1 | 保管場所ID | VARCHAR | NO | ○ | P+3桁連番 |
| 2 | 場所名 | VARCHAR | NO | - | 場所名称 |

#### T_在庫

| # | 列名 | データ型 | NULL | PK | 説明 |
|---|------|---------|------|-----|------|
| 1 | 在庫ID | VARCHAR | NO | ○ | 自動採番 |
| 2 | 製品ID | INTEGER | NO | - | FK: M_製品.製品ID |
| 3 | 保管場所ID | VARCHAR | NO | - | FK: M_保管場所.保管場所ID |
| 4 | 現在在庫数 | INTEGER | NO | - | 現在の在庫数 |
| 5 | 最終更新日時 | DATETIME | NO | - | 最終更新日時 |

#### T_入出庫履歴

| # | 列名 | データ型 | NULL | PK | 説明 |
|---|------|---------|------|-----|------|
| 1 | 履歴ID | VARCHAR | NO | ○ | 自動採番 |
| 2 | 製品ID | INTEGER | NO | - | FK: M_製品.製品ID |
| 3 | 数量 | INTEGER | NO | - | 入出庫数量 |
| 4 | 入出庫タイプ | VARCHAR | NO | - | 入庫/出庫/棚卸調整 |
| 5 | 現場名 | VARCHAR | YES | - | 出庫先現場名 |
| 6 | 客先 | VARCHAR | YES | - | 顧客名 |
| 7 | 発生日時 | DATETIME | NO | - | 入出庫発生日時 |
| 8 | 操作ユーザーID | VARCHAR | NO | - | FK: M_ユーザー.ユーザーID |
| 9 | 保管場所ID | VARCHAR | NO | - | FK: M_保管場所.保管場所ID |

---

## 5. API仕様

### 5.1 サーバーサイド関数一覧

#### 認証・認可

| 関数名 | 引数 | 戻り値 | 説明 |
|--------|------|--------|------|
| `getCurrentUser()` | なし | Object | 現在のユーザー情報 |
| `checkUserPermission(role)` | role: String | Boolean | 権限チェック |

#### 入出庫管理

| 関数名 | 引数 | 戻り値 | 説明 |
|--------|------|--------|------|
| `getStorageLocations()` | なし | Array | 保管場所一覧 |
| `getCategory1List()` | なし | Array | カテゴリ1一覧 |
| `getCategory2List(cat1)` | cat1: String | Array | カテゴリ2一覧 |
| `getProductsByCategory(cat1, cat2)` | cat1, cat2: String | Array | 製品一覧 |
| `getCurrentStock(prodId, locId)` | prodId: Number, locId: String | Number | 現在在庫数 |
| `registerStockMovement(data)` | data: Object | Object | 入出庫登録 |
| `sendLowStockAlert(prodId, locId, current, optimal)` | prodId: Number, locId: String, current: Number, optimal: Number | void | 在庫アラートメール送信 |
| `registerPastStockMovement(data)` | data: Object | Object | 過去データ調整登録 |

#### 入出庫履歴管理

| 関数名 | 引数 | 戻り値 | 説明 |
|--------|------|--------|------|
| `getMyStockMovements(filters)` | filters: Object | Array | 履歴取得 |
| `updateStockMovement(id, data)` | id: String, data: Object | Object | 履歴更新 |
| `deleteStockMovement(id)` | id: String | Object | 履歴削除 |
| `changeProductInHistory(id, newProdId)` | id: String, newProdId: Number | Object | 製品変更 |

#### 棚卸管理

| 関数名 | 引数 | 戻り値 | 説明 |
|--------|------|--------|------|
| `createInventoryEvent(name)` | name: String | Object | イベント作成 |
| `getActiveInventoryEvents()` | なし | Array | アクティブイベント取得 |
| `registerInventoryCountBatch(dataList)` | dataList: Array | Object | カウント一括登録 |
| `verifyInventoryCounts(invId)` | invId: String | Object | 照合実行 |
| `finalizeInventory(invId, details)` | invId: String, details: Array | Object | 棚卸確定 |

### 5.2 クライアント-サーバー通信

```javascript
// 呼び出し例
google.script.run
  .withSuccessHandler(function(result) {
    // 成功時処理
  })
  .withFailureHandler(function(error) {
    // 失敗時処理
  })
  .registerStockMovement(data);
```

---

## 6. セキュリティ仕様

### 6.1 認証

- Google Account Authentication使用
- セッション管理はGoogleが提供

### 6.2 認可

| 権限 | 説明 |
|------|------|
| 管理者 | 全機能にアクセス可能 |
| 現場担当 | 出庫登録、棚卸入力、在庫確認のみ |

### 6.3 データアクセス制御

- 一般ユーザーは自分の履歴のみ編集・削除可能
- 管理者は全ユーザーの履歴を編集・削除可能
- マスタ管理は管理者のみ

### 6.4 入力バリデーション

- 必須項目チェック
- データ型チェック
- 範囲チェック（数量は正の整数など）
- 在庫不足チェック

---

## 7. 非機能要件

### 7.1 性能要件

| 項目 | 要件 |
|------|------|
| 応答時間 | 通常操作は3秒以内 |
| 同時接続 | 10ユーザー程度を想定 |
| データ量 | スプレッドシート上限に依存 |

### 7.2 可用性

| 項目 | 要件 |
|------|------|
| 稼働時間 | Google Cloud Platformに依存 |
| バックアップ | スプレッドシートの自動保存機能 |

### 7.3 保守性

- 全関数のログ出力機能（`loggable()`ラッパー）
- Apps Scriptの実行ログで確認可能
- エラー発生時のスタックトレース記録

### 7.4 拡張性

- 機能追加はServerSide.gsへの関数追加で対応
- 画面追加はHTMLファイル追加とCode.gsのルーティング追加で対応

### 7.5 制限事項

| 項目 | 制限 |
|------|------|
| Apps Script実行時間 | 6分/実行 |
| スプレッドシートセル数 | 1,000万セル |
| 同時編集 | Googleの制限に依存 |

---

## 改訂履歴

| バージョン | 日付 | 内容 |
|-----------|------|------|
| 1.0.0 | 2025年11月 | 初版作成 |
| 1.1.0 | 2025年11月 | 適正在庫管理機能、メール通知機能、過去データ調整機能を追加 |

---

**作成日**: 2025年11月
**バージョン**: 1.1.0
