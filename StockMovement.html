<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>入出庫登録</title>
  <?!= include('Common'); ?>
</head>
<body class="bg-gray-100">
  <header class="bg-white shadow-md mobile-header">
    <div class="container mx-auto px-3 sm:px-4 py-3 sm:py-4">
      <div class="flex items-center justify-between">
        <h1 class="text-lg sm:text-xl font-bold text-gray-900">在庫管理システム</h1>
        <button onclick="goHome()"
                class="bg-blue-600 text-white px-3 sm:px-4 py-2 rounded-md hover:bg-blue-700 text-sm sm:text-base">
          ホーム
        </button>
      </div>
    </div>
  </header>

  <div class="container mx-auto px-3 sm:px-4 py-4 sm:py-8">
    <div class="mb-4 sm:mb-8">
      <h1 class="text-xl sm:text-3xl font-bold text-gray-900 page-title">入出庫登録</h1>
    </div>

    <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
      <form id="stock-movement-form" class="space-y-5">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-3">操作タイプ</label>
          <div class="flex space-x-6">
            <label class="flex items-center cursor-pointer">
              <input type="radio" name="type" value="入庫" class="w-5 h-5 mr-2 text-blue-600" checked>
              <span class="text-base">入庫</span>
            </label>
            <label class="flex items-center cursor-pointer">
              <input type="radio" name="type" value="出庫" class="w-5 h-5 mr-2 text-blue-600">
              <span class="text-base">出庫</span>
            </label>
          </div>
        </div>

        <div>
          <label for="location" class="block text-sm font-medium text-gray-700 mb-2">
            保管場所 <span class="text-red-500">*</span>
          </label>
          <select id="location" name="locationId" required
                  class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
            <option value="">選択してください</option>
          </select>
        </div>

        <div id="site-name-group" style="display: none;">
          <label for="siteName" class="block text-sm font-medium text-gray-700 mb-2">
            現場名・号地 <span class="text-red-500">*</span>
          </label>
          <input type="text" id="siteName" name="siteName"
                 class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                 placeholder="例: 東京現場 1号地">
        </div>

        <div id="customer-name-group" style="display: none;">
          <label for="customerName" class="block text-sm font-medium text-gray-700 mb-2">
            お客様名
          </label>
          <input type="text" id="customerName" name="customerName"
                 class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                 placeholder="例: 株式会社〇〇">
        </div>

        <div>
          <label for="category1" class="block text-sm font-medium text-gray-700 mb-2">
            カテゴリ1
          </label>
          <select id="category1" name="category1"
                  class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
            <option value="">すべて</option>
          </select>
        </div>

        <div>
          <label for="category2" class="block text-sm font-medium text-gray-700 mb-2">
            カテゴリ2
          </label>
          <select id="category2" name="category2"
                  class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
            <option value="">すべて</option>
          </select>
        </div>

        <div>
          <label for="product" class="block text-sm font-medium text-gray-700 mb-2">
            製品 <span class="text-red-500">*</span>
          </label>
          <select id="product" name="productId" required
                  class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
            <option value="">選択してください</option>
          </select>
        </div>

        <div id="current-stock-display" class="bg-blue-50 border border-blue-200 rounded-lg p-4" style="display: none;">
          <p class="text-base text-blue-700">
            現在在庫数: <span id="current-stock" class="font-bold text-lg">0</span>
          </p>
        </div>

        <div>
          <label for="quantity" class="block text-sm font-medium text-gray-700 mb-2">
            数量 <span class="text-red-500">*</span>
          </label>
          <input type="number" id="quantity" name="quantity" required min="1"
                 class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                 placeholder="数量を入力">
        </div>

        <div id="error-message" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
          <p class="text-sm text-red-700"></p>
        </div>

        <div id="success-message" class="hidden bg-green-50 border border-green-200 rounded-lg p-4">
          <p class="text-sm text-green-700"></p>
        </div>

        <div class="flex flex-col sm:flex-row gap-3 pt-2">
          <button type="submit"
                  class="flex-1 bg-blue-600 text-white py-4 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 text-base font-semibold">
            登録
          </button>
          <button type="button" onclick="goHome()"
                  class="flex-1 bg-gray-300 text-gray-700 py-4 px-4 rounded-lg hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 text-base font-semibold">
            戻る
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let currentStockValue = 0;
    
    window.addEventListener('load', function() {
      loadLocations();
      loadCategory1List();
      
      document.querySelectorAll('input[name="type"]').forEach(radio => {
        radio.addEventListener('change', handleTypeChange);
      });
      
      document.getElementById('category1').addEventListener('change', handleCategory1Change);
      document.getElementById('category2').addEventListener('change', handleCategory2Change);
      document.getElementById('product').addEventListener('change', handleProductChange);
      document.getElementById('location').addEventListener('change', handleProductChange);
      document.getElementById('stock-movement-form').addEventListener('submit', handleSubmit);
    });
    
    function loadLocations() {
      google.script.run
        .withSuccessHandler(function(data) {
          const select = document.getElementById('location');
          data.forEach(loc => {
            const option = document.createElement('option');
            option.value = loc['保管場所ID'];
            option.textContent = loc['場所名'];
            select.appendChild(option);
          });
        })
        .withFailureHandler(showError)
        .getStorageLocations();
    }
    
    function loadCategory1List() {
      google.script.run
        .withSuccessHandler(function(data) {
          const select = document.getElementById('category1');
          data.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            select.appendChild(option);
          });
        })
        .withFailureHandler(showError)
        .getCategory1List();
    }
    
    function handleTypeChange(e) {
      const isShipment = e.target.value === '出庫';
      const siteNameGroup = document.getElementById('site-name-group');
      const siteNameInput = document.getElementById('siteName');
      const customerNameGroup = document.getElementById('customer-name-group');
      const customerNameInput = document.getElementById('customerName');

      if (isShipment) {
        // 出庫時: 現場名・号地とお客様名を表示
        siteNameGroup.style.display = 'block';
        siteNameInput.required = true;
        customerNameGroup.style.display = 'block';
      } else {
        // 入庫時: 現場名・号地とお客様名を非表示
        siteNameGroup.style.display = 'none';
        siteNameInput.required = false;
        siteNameInput.value = '';
        customerNameGroup.style.display = 'none';
        customerNameInput.value = '';
      }

      if (isShipment) {
        handleProductChange();
      } else {
        document.getElementById('current-stock-display').style.display = 'none';
      }
    }
    
    function handleCategory1Change() {
      const category1 = document.getElementById('category1').value;
      const category2Select = document.getElementById('category2');
      
      category2Select.innerHTML = '<option value="">すべて</option>';
      
      if (category1) {
        google.script.run
          .withSuccessHandler(function(data) {
            data.forEach(cat => {
              const option = document.createElement('option');
              option.value = cat;
              option.textContent = cat;
              category2Select.appendChild(option);
            });
          })
          .withFailureHandler(showError)
          .getCategory2List(category1);
      }
      loadProducts();
    }
    
    function handleCategory2Change() {
      loadProducts();
    }
    
    function loadProducts() {
      const category1 = document.getElementById('category1').value;
      const category2 = document.getElementById('category2').value;
      
      google.script.run
        .withSuccessHandler(function(data) {
          const select = document.getElementById('product');
          select.innerHTML = '<option value="">選択してください</option>';
          
          data.forEach(prod => {
            const option = document.createElement('option');
            option.value = prod['製品ID'];
            option.textContent = `${prod['製品ID']} - ${prod['製品名']}`;
            select.appendChild(option);
          });
        })
        .withFailureHandler(showError)
        .getProductsByCategory(category1, category2);
    }
    
    function handleProductChange() {
      const type = document.querySelector('input[name="type"]:checked').value;
      const productId = document.getElementById('product').value;
      const locationId = document.getElementById('location').value;
      
      if (type === '出庫' && productId && locationId) {
        google.script.run
          .withSuccessHandler(function(stock) {
            currentStockValue = stock;
            document.getElementById('current-stock').textContent = stock;
            document.getElementById('current-stock-display').style.display = 'block';
          })
          .withFailureHandler(showError)
          .getCurrentStock(productId, locationId);
      } else {
        document.getElementById('current-stock-display').style.display = 'none';
      }
    }
    
    function handleSubmit(e) {
      e.preventDefault();
      hideMessages();
      
      const formData = new FormData(e.target);
      const data = {
        type: formData.get('type'),
        locationId: formData.get('locationId'),
        productId: formData.get('productId'),
        quantity: formData.get('quantity'),
        siteName: formData.get('siteName') || '',
        customerName: formData.get('customerName') || '' // ★★★ 客先（追加） ★★★
      };
      
      if (data.type === '出庫' && parseInt(data.quantity) > currentStockValue) {
        showError(`在庫不足: 現在在庫数${currentStockValue}に対して${data.quantity}の出庫はできません`);
        return;
      }
      
      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            showSuccess(result.message);
            document.getElementById('stock-movement-form').reset();
            document.getElementById('current-stock-display').style.display = 'none';
            document.getElementById('site-name-group').style.display = 'none';
            document.getElementById('customer-name-group').style.display = 'none';
          } else {
            showError(result.error);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showError('エラーが発生しました: ' + error.message);
        })
        .registerStockMovement(data);
    }
  </script>
</body>
</html>